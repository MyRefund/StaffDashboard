<!-- PROCESSING.HTML — STABLE FORMATTED VERSION -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>My Refund — Processing Workspace</title>
</head>

<body>

<div class="wrap">
<div id="workTab">

<!-- Greeting -->
<div style="margin-bottom:28px;">
  <div style="font-size:24px;font-weight:900;color:var(--g0);">
    Hello, <span id="helloName"></span>
  </div>
  <div style="margin-top:6px;font-size:13px;font-weight:800;color:var(--muted);">
    <span id="todayDate"></span> • Division: Processing
  </div>
</div>

<div class="layout">

<!-- LEFT COLUMN CONTENT REMAINS EXACTLY AS YOU HAD IT -->

</div>
</div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function(){

const TZ="Pacific/Auckland";
const name=localStorage.getItem("currentStaff")||"Processing";

let entries=[];
let submitted=false;
let currentType=null;

/* ===============================
   HEADER INIT (SAFE)
=============================== */

const staffLabel=document.getElementById("staffNameLabel");
const helloName=document.getElementById("helloName");
const todayDate=document.getElementById("todayDate");

if(staffLabel) staffLabel.textContent=name;
if(helloName) helloName.textContent=name;
if(todayDate){
  todayDate.textContent=new Date().toLocaleDateString("en-NZ",{
    weekday:"long",
    day:"numeric",
    month:"long",
    year:"numeric",
    timeZone:TZ
  });
}

/* ===============================
   HELPERS
=============================== */

function cleanAmount(v){
  return parseFloat((v||"").replace(/[$, ]/g,''))||0;
}

/* ===============================
   LOG RENDER
=============================== */

function renderLog(){
  const tbody=document.querySelector("#logTable tbody") || document.getElementById("logTable");
  if(!tbody) return;

  tbody.innerHTML="";
  const visible=entries.slice(-200);

  visible.forEach((e,i)=>{
    const realIndex=entries.length-visible.length+i;

    const row=document.createElement("tr");
    row.innerHTML=`
      <td>${e.time}</td>
      <td>${e.type}</td>
      <td>$${e.fee.toFixed(2)}</td>
      <td>
        ${!submitted
          ? `<button onclick="editEntry(${realIndex})">✎</button>
             <button onclick="deleteEntry(${realIndex})">✕</button>`
          : ''
        }
      </td>
    `;
    tbody.appendChild(row);
  });

  const entryCount=document.getElementById("entryCount");
  if(entryCount) entryCount.textContent=entries.length;
}

/* ===============================
   TOTAL UPDATE
=============================== */

function updateTotal(){
  const totalEl=document.getElementById("totalFees");
  if(!totalEl) return;

  totalEl.textContent=
    entries.reduce((s,e)=>s+e.fee,0).toFixed(2);
}

/* ===============================
   ENTRY ADD
=============================== */

window.addEntry=function(){
  if(submitted||!currentType) return;

  const amountInput=document.getElementById("amountInput");
  const amt=amountInput ? amountInput.value : "";
  const R=cleanAmount(amt);
  if(!R) return;

  const fee=calculateFee(currentType,R);

  entries.push({
    type:currentType,
    amount:R,
    fee:fee,
    time:new Date().toLocaleTimeString("en-NZ",{hour:"numeric",minute:"2-digit"})
  });

  if(currentType==="ITA"||currentType==="IR3"||currentType==="REB"){
    adj('filing',1);
  }

  if(amountInput) amountInput.value="";
  renderLog();
  updateTotal();
};

/* ===============================
   DELETE ENTRY
=============================== */

window.deleteEntry=function(index){
  if(submitted) return;

  const entry=entries[index];
  if(!entry) return;

  if(entry.type==="ITA"||entry.type==="IR3"||entry.type==="REB"){
    adj('filing',-1);
  }

  entries.splice(index,1);
  renderLog();
  updateTotal();
};

/* ===============================
   SUBMIT DAY
=============================== */

window.submitDay=function(){
  if(submitted) return;
  if(!confirm("Submit day? This cannot be edited.")) return;

  submitted=true;
  alert("Processing day successfully submitted.");
};

/* ===============================
   CLOCK (SAFE)
=============================== */

function tick(){
  const clock=document.getElementById("clock");
  if(!clock) return;

  clock.textContent=new Date().toLocaleTimeString("en-NZ",{
    hour:"numeric",
    minute:"2-digit",
    second:"2-digit"
  });
}

tick();
setInterval(tick,1000);

});
</script>

</body>
</html>
