<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>My Refund — Processing Workspace</title>

<style>
:root{
  --g0:#094B35;
  --g2:#ECFDF5;
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
  --radius:16px;
  --shadow:0 12px 32px rgba(0,0,0,.14);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Okta Neue", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color:var(--text);
}
.page{
  min-height:100vh;
  background:url("My Refund-Hero Images-02 (1).jpg") center/cover no-repeat;
  transition:.2s ease;
}
.page.submitting{opacity:.7}

/* HEADER */
.header{background:var(--g0);color:#fff;padding:14px 24px}
.header-inner{
  max-width:1300px;margin:0 auto;
  display:flex;justify-content:space-between;align-items:center;
}
.brand{display:flex;align-items:center;gap:14px}
.brand img{height:26px}
.brand-text strong{font-weight:900}
.dashboard-btn{
  border-radius:999px;padding:8px 16px;font-weight:900;
  border:1px solid #fff;background:transparent;color:#fff;cursor:pointer;
}
.clock{font-weight:900}

/* LAYOUT */
.wrap{max-width:1300px;margin:0 auto;padding:36px 24px}
.layout{display:grid;grid-template-columns:1fr 260px;gap:24px}
.panel{
  background:#fff;border-radius:16px;
  box-shadow:var(--shadow);padding:20px;margin-bottom:20px;
}
.panel h3{margin:0 0 14px;font-weight:900;color:var(--g0)}
.button-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-bottom:14px}
.type-btn{
  border-radius:12px;padding:10px;font-weight:900;
  border:2px solid var(--g0);background:#fff;color:var(--g0);cursor:pointer;
}
.type-btn.active{background:var(--g0);color:#fff}
input[type=text]{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);font-weight:700}
.inline-check{margin-top:10px;font-weight:800;color:var(--muted)}
.add-btn{margin-top:10px;padding:10px;border:none;border-radius:12px;background:var(--g0);color:#fff;font-weight:900;cursor:pointer}
.total-box{background:var(--g2);padding:14px;border-radius:12px;font-weight:900;text-align:right}

/* BUTTONS */
.action-buttons{display:flex;gap:12px;margin-top:10px}
.action-buttons button{
  flex:1;border:none;border-radius:14px;padding:14px;
  font-weight:900;background:var(--g0);color:#fff;cursor:pointer;position:relative;
}
.action-buttons button.loading{pointer-events:none;opacity:.9}
.action-buttons button.loading::after{
  content:"";position:absolute;right:18px;top:50%;
  width:16px;height:16px;margin-top:-8px;
  border:2px solid rgba(255,255,255,.5);
  border-top:2px solid #fff;border-radius:50%;
  animation:spin .8s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
.helper{margin-top:8px;font-size:12px;font-weight:800;color:var(--muted)}
@media(max-width:1100px){.layout{grid-template-columns:1fr}}
</style>
</head>

<body>
<div class="page">

<div class="header">
  <div class="header-inner">
    <div class="brand">
      <img src="logo.png">
      <div class="brand-text">
        <strong id="staffNameLabel">Processing</strong><br>
        Daily Work Logger
      </div>
    </div>
    <div>
      <button class="dashboard-btn" onclick="goHome()">← Dashboard</button>
      <span class="clock" id="clock"></span>
    </div>
  </div>
</div>

<div class="wrap">
<div class="layout">

<div>

<div class="panel">
<h3>Return Fee Logging</h3>

<div class="button-grid">
<button class="type-btn" onclick="selectType(event,'ITA')">ITA</button>
<button class="type-btn" onclick="selectType(event,'IR3')">IR3</button>
<button class="type-btn" onclick="selectType(event,'REB')">REB</button>
</div>

<div id="inputSection" style="display:none;">
<input type="text" id="amountInput" placeholder="Refund Amount">

<label id="backYearLabel" class="inline-check" style="display:none;">
<input type="checkbox" id="backYear"> Back Year (remove $29.50 service component)
</label>

<label id="receiptLabel" class="inline-check" style="display:none;">
<input type="checkbox" id="receiptAssist"> Receipt Assistance (REB only)
</label>

<div class="helper" id="feeHelper"></div>

<button class="add-btn" onclick="addEntry()">Add</button>
</div>
</div>

<div class="panel">
<div class="total-box">
Total Fees Today: $<span id="totalFees">0.00</span>
</div>
</div>

<div class="action-buttons">
<button id="updateBtn" onclick="updateDay()">Update</button>
<button id="submitBtn" onclick="submitDay()">Submit & Finish Day</button>
</div>

</div>

<div>
<div class="panel">
<h3>Quick Contacts</h3>
<strong>My Refund</strong><br>
0800 80 89 89<br>
info@myrefund.co.nz
</div>
</div>

</div>
</div>
</div>

<script>
document.addEventListener("DOMContentLoaded",function(){

const WEB_APP_URL="https://script.google.com/macros/s/AKfycbwCZTuvnbwTAfkDXMjbLzCR-YXkzcbQ-hujbrZW7Hib5iLhbVwfkJ1xmSfpu-YfRGTn/exec";
const name=localStorage.getItem("currentStaff")||"Processing";
document.getElementById("staffNameLabel").textContent=name;

let entries=[];
let currentType=null;
let submitted=false;

/* CLOCK */
setInterval(()=>{clock.textContent=new Date().toLocaleTimeString("en-NZ")},1000);

/* NAV */
window.goHome=function(){window.location.href="index.html"};

/* CLEAN AMOUNT */
function clean(v){return parseFloat(String(v||"").replace(/[$, ]/g,''))||0}

/* FEE CALCULATION — FINAL COMMERCIAL LOGIC */
function calculateFee(type,R,receiptAssist,backYear){

if(type==="ITA"){
let base=R*0.11;
if(backYear){base+=5}else{base+=29.5+5}
let fee=base*1.15;
if(R<39.68)return R;
if(fee>345)fee=345;
return fee;
}

if(type==="IR3"){
let base=R*0.11;
if(backYear){base+=20}else{base+=29.5+20}
let fee=base*1.15;
if(backYear){if(R<23)return R}else{if(R<56.93)return R}
if(fee>402.5)fee=402.5;
return fee;
}

if(type==="REB"){
let tier=R<500?45.99:(R<2000?68.99:91.99);
if(receiptAssist)tier+=6.89;
return R<tier?R:tier;
}

return 0;
}

/* SELECT TYPE */
window.selectType=function(e,type){
currentType=type;
document.querySelectorAll(".type-btn").forEach(b=>b.classList.remove("active"));
e.target.classList.add("active");
inputSection.style.display="block";
backYearLabel.style.display=(type==="ITA"||type==="IR3")?"block":"none";
receiptLabel.style.display=(type==="REB")?"block":"none";
updateHelper();
};

/* HELPER */
function updateHelper(){
if(!currentType)return;
let R=clean(amountInput.value);
if(!R){feeHelper.textContent="";return;}
let fee=calculateFee(currentType,R,receiptAssist.checked,backYear.checked);
feeHelper.textContent="Estimated fee: $"+fee.toFixed(2)+" (incl GST)";
}

amountInput.addEventListener("input",updateHelper);
receiptAssist.addEventListener("change",updateHelper);
backYear.addEventListener("change",updateHelper);

/* ADD ENTRY */
window.addEntry=function(){
if(!currentType)return;
let R=clean(amountInput.value);
if(!R)return;
let fee=calculateFee(currentType,R,receiptAssist.checked,backYear.checked);
entries.push({type:currentType,amount:R,fee});
updateTotal();
amountInput.value="";
updateHelper();
};

/* TOTAL */
function updateTotal(){
let total=entries.reduce((s,e)=>s+e.fee,0);
totalFees.textContent=total.toFixed(2);
}

/* UPDATE (LIVE PUSH — DOES NOT LOCK) */
window.updateDay=async function(){
if(submitted)return;
let btn=document.getElementById("updateBtn");
btn.classList.add("loading");
btn.textContent="Updating...";
let formData=new URLSearchParams();
formData.append("action","updateProcessingLive");
formData.append("staff",name);
formData.append("entries",JSON.stringify(entries));
await fetch(WEB_APP_URL,{method:"POST",mode:"no-cors",body:formData});
btn.classList.remove("loading");
btn.textContent="Update ✓";
setTimeout(()=>{btn.textContent="Update"},1500);
};

/* SUBMIT FINAL */
window.submitDay=async function(){
if(submitted)return;
if(!confirm("Submit day? This cannot be edited."))return;
submitted=true;
let btn=document.getElementById("submitBtn");
btn.classList.add("loading");
btn.textContent="Submitting...";
let formData=new URLSearchParams();
formData.append("action","submitProcessing");
formData.append("staff",name);
formData.append("entries",JSON.stringify(entries));
await fetch(WEB_APP_URL,{method:"POST",mode:"no-cors",body:formData});
btn.textContent="Submitted ✓";
setTimeout(()=>{window.location.href="index.html"},2000);
};

});
</script>

</body>
</html>
