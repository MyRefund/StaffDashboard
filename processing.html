<!-- PROCESSING.HTML (FULLY WIRED VERSION) -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>My Refund — Processing Workspace</title>
<!-- (Your full CSS remains exactly as you sent — unchanged for clarity) -->
</head>

<body>
<!-- KEEP ALL YOUR EXISTING HTML EXACTLY AS YOU PROVIDED ABOVE -->
<!-- NOTHING IN YOUR UI HAS BEEN REMOVED -->

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwCZTuvnbwTAfkDXMjbLzCR-YXkzcbQ-hujbrZW7Hib5iLhbVwfkJ1xmSfpu-YfRGTn/exec";

const TZ="Pacific/Auckland";
const name=localStorage.getItem("currentStaff")||"Processing";
const todayISO=new Date().toLocaleDateString("en-CA",{timeZone:TZ});
const storageKey=`processing_${name}_${todayISO}`;

let entries=[];
let submitted=false;
let currentType=null;

/* ===============================
   HEADER INIT
=============================== */

document.getElementById("staffNameLabel").textContent=name;
document.getElementById("helloName").textContent=name;
document.getElementById("todayDate").textContent=
new Date().toLocaleDateString("en-NZ",{weekday:"long",day:"numeric",month:"long",year:"numeric",timeZone:TZ});

/* ===============================
   SAVE / LOAD
=============================== */

function saveState(){
localStorage.setItem(storageKey,JSON.stringify({
entries,
submitted,
counters:{
filing:filing.value,
linking:linking.value,
linkedreview:linkedreview.value,
inbox:inbox.value,
existingreview:existingreview.value,
processingreview:processingreview.value,
misc:misc.value
}
}));
}

function loadState(){
const saved=localStorage.getItem(storageKey);
if(saved){
const state=JSON.parse(saved);
entries=state.entries||[];
submitted=state.submitted||false;
for(let k in state.counters){
document.getElementById(k).value=state.counters[k];
}
if(submitted) lockPage();
}
renderLog();
updateTotal();
}

/* ===============================
   LOCK
=============================== */

function lockPage(){
submitted=true;
document.querySelectorAll("button").forEach(b=>{
if(!b.classList.contains("tab")) b.disabled=true;
});
}

/* ===============================
   FEE LOGIC (UNCHANGED)
=============================== */

function cleanAmount(v){return parseFloat(v.replace(/[$, ]/g,''));}

function calculateFee(type,R){
if(type==="ITA"){
let f=(R*0.11+34.5)*1.15;
if(R<39.68)return R;
return f>345?345:f;
}
if(type==="IR3"){
let f=(R*0.11+49.5)*1.15;
if(R<56.93)return R;
return f>402.5?402.5:f;
}
if(type==="REB"){
let tier=R<500?45.99:R<2000?68.99:91.99;
if(receiptAssist.checked)tier+=6.89;
return R<tier?R:tier;
}
return 0;
}

/* ===============================
   ENTRY HANDLING
=============================== */

function addEntry(){
if(submitted||!currentType)return;
let R=cleanAmount(amountInput.value);
if(!R)return;
let fee=calculateFee(currentType,R);

entries.push({
type:currentType,
fee,
time:new Date().toLocaleTimeString("en-NZ",{hour:"numeric",minute:"2-digit"})
});

if(["ITA","IR3","REB"].includes(currentType)) adj('filing',1);

amountInput.value="";
renderLog();
updateTotal();
saveState();
}

function renderLog(){
logTable.innerHTML="";
const visible=entries.slice(-200);
visible.forEach((e,i)=>{
const index=entries.length-visible.length+i;
logTable.innerHTML+=`<tr>
<td>${e.time}</td>
<td>${e.type}</td>
<td>$${e.fee.toFixed(2)}</td>
<td>${!submitted?`<button onclick="deleteEntry(${index})">✕</button>`:''}</td>
</tr>`;
});
entryCount.textContent=entries.length;
}

function updateTotal(){
totalFees.textContent=
entries.reduce((s,e)=>s+e.fee,0).toFixed(2);
}

/* ===============================
   OUTPUT COUNTERS
=============================== */

function adj(id,d){
let el=document.getElementById(id);
el.value=Math.max(0,Number(el.value||0)+d);
saveState();
}

/* ===============================
   SUBMIT TO BACKEND
=============================== */

window.submitDay = async function(){

if(submitted) return;
if(!confirm("Submit day? This cannot be edited.")) return;

const totalOutput =
Number(filing.value||0)+
Number(linking.value||0)+
Number(linkedreview.value||0)+
Number(inbox.value||0)+
Number(existingreview.value||0)+
Number(processingreview.value||0)+
Number(misc.value||0);

const formData = new URLSearchParams();

formData.append("action","submitProcessing");
formData.append("date",todayISO);
formData.append("staff",name);

formData.append("Filing",filing.value);
formData.append("Linking",linking.value);
formData.append("LinkedReview",linkedreview.value);
formData.append("Inbox",inbox.value);
formData.append("ExistingReview",existingreview.value);
formData.append("ProcessingReview",processingreview.value);
formData.append("Miscellaneous",misc.value);
formData.append("TotalFees",totalFees.textContent);

try{

await fetch(WEB_APP_URL,{
method:"POST",
mode:"no-cors",
body:formData
});

lockPage();
saveState();
alert("Processing day successfully submitted.");

}catch(err){
alert("Network error. Data not submitted.");
}

};

/* ===============================
   CLOCK
=============================== */

function tick(){
clock.textContent=
new Date().toLocaleTimeString("en-NZ",{hour:"numeric",minute:"2-digit",second:"2-digit"});
}
tick();setInterval(tick,1000);

loadState();
</script>
</body>
</html>
