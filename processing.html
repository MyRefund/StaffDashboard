<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="Content-Language" content="en">
<meta name="google" content="notranslate">
<title>My Refund — Processing Workspace</title>

<style>
:root{
  --g0:#094B35;
  --g2:#ECFDF5;
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
  --radius:16px;
  --shadow:0 12px 32px rgba(0,0,0,.14);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Okta Neue", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color:var(--text);
}
.page{
  min-height:100vh;
  background:url("My Refund-Hero Images-02 (1).jpg") center / cover no-repeat;
  transition:.2s ease;
}
.page.submitting{ opacity:.7; }

/* HEADER */
.header{
  background:var(--g0);
  color:#fff;
  padding:14px 24px;
}
.header-inner{
  max-width:1300px;
  margin:0 auto;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.brand{
  display:flex;
  align-items:center;
  gap:14px;
}
.brand img{height:26px}
.brand-text strong{font-size:15px;font-weight:900}
.brand-text span{font-size:12px;opacity:.9;font-weight:700}
.header-right{
  display:flex;
  align-items:center;
  gap:14px;
}
.dashboard-btn{
  border-radius:999px;
  padding:8px 16px;
  font-weight:900;
  font-size:13px;
  border:1px solid #fff;
  background:transparent;
  color:#fff;
  cursor:pointer;
}
.clock{font-weight:900;font-size:14px}

/* TABS */
.tabs{
  background:#fff;
  padding:12px 24px;
  display:flex;
  gap:10px;
  border-bottom:1px solid var(--border);
}
.tab{
  border-radius:999px;
  padding:8px 16px;
  font-weight:900;
  font-size:13px;
  border:1px solid var(--g0);
  background:#fff;
  color:var(--g0);
  cursor:pointer;
}
.tab.active{background:var(--g0);color:#fff;}

.wrap{
  max-width:1300px;
  margin:0 auto;
  padding:36px 24px 60px;
}

.layout{
  display:grid;
  grid-template-columns:1fr 260px;
  gap:24px;
}
.panel{
  background:rgba(255,255,255,.96);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:20px;
  margin-bottom:20px;
}
.panel h3{
  margin:0 0 14px 0;
  font-size:18px;
  font-weight:900;
  color:var(--g0);
}
.fee-panel{border-top:6px solid var(--g0);}

.banner{
  background:#fff3cd;
  border-left:6px solid #f0ad4e;
  padding:12px 16px;
  margin-bottom:20px;
  font-weight:800;
  border-radius:12px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:14px;
}
.item{
  background:#fff;
  border:1px solid var(--border);
  border-radius:14px;
  padding:14px;
}
.item label{
  display:block;
  font-weight:900;
  margin-bottom:8px;
}
.controls{
  display:flex;
  align-items:center;
  gap:6px;
}
.controls button{
  width:32px;height:32px;
  border-radius:8px;
  border:1px solid var(--border);
  background:#fff;
  font-weight:900;
  cursor:pointer;
}
.controls input{
  width:56px;
  text-align:center;
  border:1px solid var(--border);
  border-radius:8px;
  padding:6px;
  font-weight:900;
}

.button-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
  gap:12px;
  margin-bottom:16px;
}
.type-btn{
  border-radius:12px;
  padding:10px;
  font-weight:900;
  border:2px solid var(--g0);
  background:#fff;
  color:var(--g0);
  cursor:pointer;
}
.type-btn.active{background:var(--g0);color:#fff;}

input[type="text"]{
  padding:10px;
  border-radius:10px;
  border:1px solid var(--border);
  font-weight:700;
  width:100%;
}

.add-btn{
  margin-top:10px;
  padding:10px 16px;
  border:none;
  border-radius:12px;
  background:var(--g0);
  color:#fff;
  font-weight:900;
  cursor:pointer;
}

table{width:100%;border-collapse:collapse;}
th,td{border-bottom:1px solid var(--border);padding:8px;font-size:13px;}
th{color:var(--muted);font-weight:900;text-align:left;}
td button{
  border:1px solid var(--border);
  background:#fff;
  border-radius:8px;
  padding:6px 8px;
  cursor:pointer;
  font-weight:900;
}

.total-box{
  background:var(--g2);
  border-radius:12px;
  padding:14px;
  font-weight:900;
  font-size:18px;
  text-align:right;
}

/* SUBMIT BUTTON LOADING */
.submit button{
  width:100%;
  border-radius:14px;
  padding:14px;
  font-weight:900;
  font-size:15px;
  border:none;
  background:var(--g0);
  color:#fff;
  cursor:pointer;
  position:relative;
}
.submit button.loading{
  pointer-events:none;
  opacity:.95;
}
.submit button.loading::after{
  content:"";
  position:absolute;
  right:18px;
  top:50%;
  width:16px;
  height:16px;
  margin-top:-8px;
  border:2px solid rgba(255,255,255,.5);
  border-top:2px solid #fff;
  border-radius:50%;
  animation:spin .8s linear infinite;
}
@keyframes spin{
  from{transform:rotate(0deg)}
  to{transform:rotate(360deg)}
}

.collapsible-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
  font-weight:900;
}
.hidden{display:none;}

.inline-check{
  display:flex;
  align-items:center;
  gap:10px;
  margin-top:10px;
  padding:10px 12px;
  border:1px solid var(--border);
  border-radius:12px;
  background:#fff;
}
.inline-check span{
  font-weight:900;
  color:var(--muted);
  font-size:13px;
}
.helper{
  margin-top:10px;
  color:var(--muted);
  font-weight:800;
  font-size:12px;
  line-height:1.4;
}

@media(max-width:1100px){
  .layout{grid-template-columns:1fr}
}
</style>
</head>

<body>
<div class="page">

  <div class="header">
    <div class="header-inner">
      <div class="brand">
        <img src="logo.png" alt="My Refund">
        <div class="brand-text">
          <strong id="staffNameLabel">Processing</strong>
          <span>Daily Work Logger</span>
        </div>
      </div>
      <div class="header-right">
        <button class="dashboard-btn" onclick="goHome()">← Dashboard</button>
        <div class="clock" id="clock"></div>
      </div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('work', this)">Work Log</button>
    <button class="tab" onclick="switchTab('resources', this)">Resources</button>
  </div>

  <div class="wrap">

    <div id="workTab">

      <div id="warningBanner" class="banner hidden"></div>

      <div style="margin-bottom:28px;">
        <div style="font-size:24px;font-weight:900;color:var(--g0);">
          Hello, <span id="helloName"></span>
        </div>
        <div style="margin-top:6px;font-size:13px;font-weight:800;color:var(--muted);">
          <span id="todayDate"></span> • Division: Processing
        </div>
      </div>

      <div class="layout">

        <!-- LEFT -->
        <div>

          <div class="panel">
            <h3>Processing Output</h3>
            <div class="grid">

              <div class="item">
                <label>Filing</label>
                <div class="controls">
                  <button onclick="adj('filing',-1)">−</button>
                  <input id="filing" value="0">
                  <button onclick="adj('filing',1)">+</button>
                </div>
              </div>

              <div class="item">
                <label>Linking</label>
                <div class="controls">
                  <button onclick="adj('linking',-1)">−</button>
                  <input id="linking" value="0">
                  <button onclick="adj('linking',1)">+</button>
                </div>
              </div>

              <div class="item">
                <label>Linked Review</label>
                <div class="controls">
                  <button onclick="adj('linkedreview',-1)">−</button>
                  <input id="linkedreview" value="0">
                  <button onclick="adj('linkedreview',1)">+</button>
                </div>
              </div>

              <div class="item">
                <label>Inbox</label>
                <div class="controls">
                  <button onclick="adj('inbox',-1)">−</button>
                  <input id="inbox" value="0">
                  <button onclick="adj('inbox',1)">+</button>
                </div>
              </div>

              <div class="item">
                <label>Existing Review</label>
                <div class="controls">
                  <button onclick="adj('existingreview',-1)">−</button>
                  <input id="existingreview" value="0">
                  <button onclick="adj('existingreview',1)">+</button>
                </div>
              </div>

              <div class="item">
                <label>Processing Review</label>
                <div class="controls">
                  <button onclick="adj('processingreview',-1)">−</button>
                  <input id="processingreview" value="0">
                  <button onclick="adj('processingreview',1)">+</button>
                </div>
              </div>

              <div class="item">
                <label>Miscellaneous</label>
                <div class="controls">
                  <button onclick="adj('misc',-1)">−</button>
                  <input id="misc" value="0">
                  <button onclick="adj('misc',1)">+</button>
                </div>
              </div>

            </div>
          </div>

          <div class="panel fee-panel">
            <h3>Return Fee Logging</h3>

            <div class="button-grid">
              <button class="type-btn" onclick="selectType(event,'ITA')">ITA</button>
              <button class="type-btn" onclick="selectType(event,'IR3')">IR3</button>
              <button class="type-btn" onclick="selectType(event,'REB')">REB</button>
              <button class="type-btn" onclick="autoAdd('AA')">AA</button>
              <button class="type-btn" onclick="autoAdd('R3P')">R3P</button>
              <button class="type-btn" onclick="autoAdd('OP')">OP</button>
            </div>

            <div id="inputSection" class="hidden">
              <input type="text" id="amountInput" placeholder="Refund Amount">

              <!-- IR3 Back Year (only for IR3) -->
              <label id="backYearLabel" class="hidden inline-check" style="margin-top:10px;">
                <input type="checkbox" id="backYear">
                <span>IR3 Back Year (no $29.50+GST component)</span>
              </label>

              <!-- Receipt assist (only for REB) -->
              <label id="receiptLabel" class="hidden inline-check" style="margin-top:10px;">
                <input type="checkbox" id="receiptAssist">
                <span>Receipt assistance (REB only)</span>
              </label>

              <div class="helper" id="feeHelper" style="display:none;"></div>

              <button class="add-btn" onclick="addEntry()">Add</button>
            </div>
          </div>

          <div class="panel fee-panel">
            <div class="collapsible-header" onclick="toggleLog()">
              <span>Today’s Fee Entries (<span id="entryCount">0</span> total · showing last 200)</span>
              <span id="toggleIcon">▼</span>
            </div>

            <div id="logContainer" class="hidden">
              <table>
                <thead>
                  <tr><th>Time</th><th>Type</th><th>Fee</th><th></th></tr>
                </thead>
                <tbody id="logTable"></tbody>
              </table>
            </div>
          </div>

          <div class="panel fee-panel">
            <div class="total-box">
              Total Fees Today: $<span id="totalFees">0.00</span>
            </div>
          </div>

          <div class="submit">
            <button onclick="submitDay()">Submit & Finish Day</button>
          </div>

        </div>

        <!-- RIGHT -->
        <div>
          <div class="panel">
            <h3>Quick Contacts</h3>
            <strong>My Refund</strong><br>
            0800 80 89 89<br>
            info@myrefund.co.nz<br>
            myrefund.co.nz<br><br>
            <strong>IRD</strong><br>
            ird.govt.nz<br>
            0800 227 774
          </div>
        </div>

      </div>
    </div>

    <div id="resourcesTab" class="hidden">
      <div class="panel">
        <h3>Resources</h3>
        <p>No resources added yet.</p>
      </div>
    </div>

  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function(){

  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwCZTuvnbwTAfkDXMjbLzCR-YXkzcbQ-hujbrZW7Hib5iLhbVwfkJ1xmSfpu-YfRGTn/exec";
  const TZ = "Pacific/Auckland";
  const name = localStorage.getItem("currentStaff") || "Processing";
  const todayISO = new Date().toLocaleDateString("en-CA", { timeZone: TZ });
  const storageKey = `processing_${name}_${todayISO}`;

  let entries = [];
  let submitted = false;
  let currentType = null;

  /* NAV */
  window.goHome = function(){ window.location.href="index.html"; };

  /* HEADER INIT */
  document.getElementById("staffNameLabel").textContent = name;
  document.getElementById("helloName").textContent = name;
  document.getElementById("todayDate").textContent =
    new Date().toLocaleDateString("en-NZ", { weekday:"long", day:"numeric", month:"long", year:"numeric", timeZone: TZ });

  /* ENTER KEY ADDS ENTRY */
  const amountInput = document.getElementById("amountInput");
  amountInput.addEventListener("keydown", function(e){
    if(e.key === "Enter"){
      e.preventDefault();
      window.addEntry();
    }
  });

  /* SAVE / LOAD */
  function saveState(){
    localStorage.setItem(storageKey, JSON.stringify({
      entries,
      submitted,
      counters:{
        filing: filing.value,
        linking: linking.value,
        linkedreview: linkedreview.value,
        inbox: inbox.value,
        existingreview: existingreview.value,
        processingreview: processingreview.value,
        misc: misc.value
      }
    }));
  }

  function loadState(){
    const saved = localStorage.getItem(storageKey);
    if(saved){
      const state = JSON.parse(saved);
      entries = state.entries || [];
      submitted = state.submitted || false;

      if(state.counters){
        for(let k in state.counters){
          const el = document.getElementById(k);
          if(el) el.value = state.counters[k];
        }
      }

      if(submitted) lockPage();
    }
    renderLog();
    updateTotal();
    checkYesterday();
  }

  /* YESTERDAY CHECK */
  function checkYesterday(){
    const yesterdayISO = new Date(Date.now() - 86400000).toLocaleDateString("en-CA", { timeZone: TZ });
    const yesterdayKey = `processing_${name}_${yesterdayISO}`;
    const old = localStorage.getItem(yesterdayKey);
    if(old){
      const data = JSON.parse(old);
      if(!data.submitted){
        const banner = document.getElementById("warningBanner");
        banner.textContent = "Yesterday was not submitted. Please notify Admin if required.";
        banner.classList.remove("hidden");
      }
    }
  }

  /* LOCK */
  function lockPage(){
    submitted = true;
    document.querySelectorAll("button").forEach(b=>{
      if(!b.classList.contains("tab") && !b.classList.contains("dashboard-btn")) b.disabled = true;
    });
  }

  /* FEE LOGIC */
  function cleanAmount(v){
    return parseFloat(String(v||"").replace(/[$, ]/g,'')) || 0;
  }

  // ✅ Final rules (fees include GST)
  // ITA min refund threshold: 39.68 (if R below, fee = R). Cap 345.
  // IR3 min refund threshold: 56.93 (if R below, fee = R). Cap 402.5.
  // IR3 Back Year min threshold: 23 (if R below, fee = R). Cap 402.5. Formula: (R*0.11)*1.15 (no +49.5).
  // REB tier: 45.99 / 68.99 / 91.99 (+6.89 receipt assist). If refund below tier, fee = R.
  function calculateFee(type, R, receiptAssistChecked, backYearChecked){

    if(type==="ITA"){
      if(R < 39.68) return R;
      let f = (R*0.11 + 34.5) * 1.15;
      return f > 345 ? 345 : f;
    }

    if(type==="IR3"){
      if(backYearChecked){
        if(R < 23) return R;
        let f = (R*0.11) * 1.15;
        return f > 402.5 ? 402.5 : f;
      }
      if(R < 56.93) return R;
      let f = (R*0.11 + 49.5) * 1.15;
      return f > 402.5 ? 402.5 : f;
    }

    if(type==="REB"){
      let tier = R < 500 ? 45.99 : (R < 2000 ? 68.99 : 91.99);
      if(receiptAssistChecked) tier += 6.89;
      return R < tier ? R : tier;
    }

    return 0;
  }

  function money2(n){
    return Number(n||0).toFixed(2);
  }

  function updateHelper(type){
    const helper = document.getElementById("feeHelper");
    const backYearChecked = document.getElementById("backYear").checked;
    const receiptAssistChecked = document.getElementById("receiptAssist").checked;
    const R = cleanAmount(amountInput.value);

    if(!type){
      helper.style.display="none";
      helper.textContent="";
      return;
    }

    if(!R){
      helper.style.display="none";
      helper.textContent="";
      return;
    }

    const fee = calculateFee(type, R, receiptAssistChecked, backYearChecked);
    helper.style.display="block";
    helper.textContent = `Estimated fee: $${money2(fee)} (incl. GST)`;
  }

  /* GLOBALS FOR INLINE ONCLICK */
  window.switchTab = function(tab, btn){
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById("workTab").classList.toggle("hidden", tab !== "work");
    document.getElementById("resourcesTab").classList.toggle("hidden", tab !== "resources");
  };

  window.adj = function(id, d){
    if(submitted) return;
    const el = document.getElementById(id);
    let v = Math.max(0, Number(el.value||0) + d);
    el.value = v;
    saveState();
  };

  window.toggleLog = function(){
    const logContainer = document.getElementById("logContainer");
    const toggleIcon = document.getElementById("toggleIcon");
    logContainer.classList.toggle("hidden");
    toggleIcon.textContent = logContainer.classList.contains("hidden") ? "▼" : "▲";
  };

  function setTypeButtonActive(type){
    document.querySelectorAll(".type-btn").forEach(b=>b.classList.remove("active"));
    const btns = Array.from(document.querySelectorAll(".type-btn"));
    const match = btns.find(b => (b.textContent||"").trim() === type);
    if(match) match.classList.add("active");
  }

  function resetTypeToggles(){
    // Back Year only IR3
    document.getElementById("backYearLabel").classList.add("hidden");
    document.getElementById("backYear").checked = false;

    // Receipt assist only REB
    document.getElementById("receiptLabel").classList.add("hidden");
    document.getElementById("receiptAssist").checked = false;
  }

  window.selectType = function(e, type){
    if(submitted) return;

    currentType = type;

    document.querySelectorAll(".type-btn").forEach(b=>b.classList.remove("active"));
    e.target.classList.add("active");

    document.getElementById("inputSection").classList.remove("hidden");

    resetTypeToggles();

    if(type === "REB"){
      document.getElementById("receiptLabel").classList.remove("hidden");
    }

    if(type === "IR3"){
      document.getElementById("backYearLabel").classList.remove("hidden");
    }

    updateHelper(currentType);
    amountInput.focus();
  };

  window.autoAdd = function(type){
    if(submitted) return;

    // fixed fee types (AA, R3P, OP): $39.10
    const fee = 39.10;

    entries.push({
      type,
      amount: null,
      fee,
      receiptAssist: false,
      backYear: false,
      time: new Date().toLocaleTimeString("en-NZ",{hour:"numeric",minute:"2-digit"})
    });

    renderLog();
    updateTotal();
    saveState();
  };

  window.addEntry = function(){
    if(submitted || !currentType) return;

    const receiptAssistChecked = document.getElementById("receiptAssist").checked;
    const backYearChecked = document.getElementById("backYear").checked;

    const R = cleanAmount(amountInput.value);
    if(!R) return;

    const fee = calculateFee(currentType, R, receiptAssistChecked, backYearChecked);

    entries.push({
      type: currentType,
      amount: R,
      fee: fee,
      receiptAssist: (currentType==="REB") ? receiptAssistChecked : false,
      backYear: (currentType==="IR3") ? backYearChecked : false,
      time: new Date().toLocaleTimeString("en-NZ",{hour:"numeric",minute:"2-digit"})
    });

    // Original behaviour: filing count increments for ITA/IR3/REB
    if(["ITA","IR3","REB"].includes(currentType)) window.adj("filing", 1);

    amountInput.value = "";
    // keep toggles as-is for speed (esp. IR3 back year), but refresh helper
    updateHelper(currentType);

    renderLog();
    updateTotal();
    saveState();
    amountInput.focus();
  };

  window.editEntry = function(index){
    if(submitted) return;

    const entry = entries[index];
    if(!entry) return;

    if(!["ITA","IR3","REB"].includes(entry.type)){
      alert("Only ITA / IR3 / REB entries can be edited.");
      return;
    }

    const v = prompt("Enter new refund amount:");
    if(v === null) return;

    const R = cleanAmount(v);
    if(!R) return;

    const fee = calculateFee(entry.type, R, entry.receiptAssist === true, entry.backYear === true);

    entry.amount = R;
    entry.fee = fee;

    renderLog();
    updateTotal();
    saveState();
  };

  window.deleteEntry = function(index){
    if(submitted) return;

    const entry = entries[index];
    if(!entry) return;

    // reverse filing count if ITA/IR3/REB
    if(["ITA","IR3","REB"].includes(entry.type)) window.adj("filing", -1);

    entries.splice(index, 1);
    renderLog();
    updateTotal();
    saveState();
  };

  function renderLog(){
    const tbody = document.getElementById("logTable");
    tbody.innerHTML = "";

    const visible = entries.slice(-200);
    visible.forEach((e, i)=>{
      const realIndex = entries.length - visible.length + i;

      const typeLabel =
        e.type === "IR3" && e.backYear === true ? "IR3 (Back Year)" :
        e.type;

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${e.time}</td>
        <td>${typeLabel}${e.type==="REB" && e.receiptAssist ? " + RA" : ""}</td>
        <td>$${Number(e.fee||0).toFixed(2)}</td>
        <td>${!submitted ? `
          <button onclick="editEntry(${realIndex})" title="Edit">✎</button>
          <button onclick="deleteEntry(${realIndex})" title="Delete">✕</button>
        ` : ""}</td>
      `;
      tbody.appendChild(row);
    });

    document.getElementById("entryCount").textContent = entries.length;
  }

  function updateTotal(){
    const total = entries.reduce((s,e)=> s + Number(e.fee||0), 0);
    document.getElementById("totalFees").textContent = total.toFixed(2);
  }

  /* SUBMIT TO BACKEND */
  window.submitDay = async function(){
    if(submitted) return;
    if(!confirm("Submit day? This cannot be edited.")) return;

    const btn = document.querySelector(".submit button");
    btn.classList.add("loading");
    btn.textContent = "Submitting...";
    document.querySelector(".page").classList.add("submitting");

    const formData = new URLSearchParams();
    formData.append("action","submitProcessing");
    formData.append("date",todayISO);
    formData.append("staff",name);

    formData.append("Filing",filing.value);
    formData.append("Linking",linking.value);
    formData.append("LinkedReview",linkedreview.value);
    formData.append("Inbox",inbox.value);
    formData.append("ExistingReview",existingreview.value);
    formData.append("ProcessingReview",processingreview.value);
    formData.append("Miscellaneous",misc.value);

    formData.append("TotalFees",document.getElementById("totalFees").textContent);
    formData.append("feeEntries", JSON.stringify(entries));

    try{
      await fetch(WEB_APP_URL, { method:"POST", mode:"no-cors", body: formData });

      lockPage();
      saveState();

      btn.classList.remove("loading");
      btn.textContent = "Submitted ✓";

      setTimeout(()=>{ window.location.href="index.html"; }, 2000);

    }catch(err){
      btn.classList.remove("loading");
      btn.textContent = "Submit & Finish Day";
      document.querySelector(".page").classList.remove("submitting");
      alert("Network error. Data not submitted.");
    }
  };

  /* INPUT LISTENERS (helper estimate) */
  amountInput.addEventListener("input", ()=>updateHelper(currentType));
  document.getElementById("receiptAssist").addEventListener("change", ()=>updateHelper(currentType));
  document.getElementById("backYear").addEventListener("change", ()=>updateHelper(currentType));

  /* CLOCK */
  function tick(){
    document.getElementById("clock").textContent =
      new Date().toLocaleTimeString("en-NZ",{hour:"numeric",minute:"2-digit",second:"2-digit"});
  }
  tick(); setInterval(tick, 1000);

  loadState();

});
</script>

</body>
</html>
