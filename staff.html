<script>
const TZ="Pacific/Auckland";
const name=localStorage.getItem("currentStaff")||"CSR";
const todayISO=new Date().toLocaleDateString("en-CA",{timeZone:TZ});
const storageKey=`csr_${name}_${todayISO}`;

let manualOutbound=0;
let submitted=false;

document.getElementById("staffNameLabel").textContent=name;
document.getElementById("helloText").textContent="Hello, "+name;

/* ================= SAVE / LOAD ================= */

function saveState(){
  const data={
    submitted,
    manualOutbound,
    counters:{
      inbound:inbound.value,
      chat:chat.value,
      outbound:outbound.value,
      a2a:a2a.value,
      unverified:unverified.value,
      emails:emails.value,
      inccalling:inccalling.value,
      questioncalling:questioncalling.value,
      a2acalling:a2acalling.value,
      delink:delink.value,
      cancel:cancel.value
    }
  };
  localStorage.setItem(storageKey,JSON.stringify(data));
}

function loadState(){
  const saved=localStorage.getItem(storageKey);
  if(!saved) return;

  const data=JSON.parse(saved);
  submitted=data.submitted||false;
  manualOutbound=data.manualOutbound||0;

  for(let k in data.counters){
    if(document.getElementById(k)){
      document.getElementById(k).value=data.counters[k];
    }
  }

  if(submitted) lockPage();
  updateOutbound();
}

function lockPage(){
  submitted=true;
  document.querySelectorAll("button").forEach(b=>{
    if(!b.classList.contains("tab")) b.disabled=true;
  });
}

/* ================= RESET CHECK ================= */

function checkNewDay(){
  const yesterday=new Date(Date.now()-86400000)
    .toLocaleDateString("en-CA",{timeZone:TZ});
  const oldKey=`csr_${name}_${yesterday}`;
  const old=localStorage.getItem(oldKey);
  if(old){
    const d=JSON.parse(old);
    if(!d.submitted){
      console.warn("Yesterday not submitted.");
    }
  }
}

/* ================= COUNTERS ================= */

function adj(id,d){
  if(submitted) return;
  const el=document.getElementById(id);
  let v=Number(el.value||0)+d;
  if(v<0)v=0;
  el.value=v;
  saveState();
}

function adjManualOutbound(d){
  if(submitted) return;
  manualOutbound+=d;
  if(manualOutbound<0)manualOutbound=0;
  updateOutbound();
  saveState();
}

function adjCalling(id,d){
  if(submitted) return;
  const el=document.getElementById(id);
  let v=Number(el.value||0)+d;
  if(v<0)v=0;
  el.value=v;
  updateOutbound();
  saveState();
}

function updateOutbound(){
  const inc=Number(inccalling.value||0);
  const q=Number(questioncalling.value||0);
  const a2aCall=Number(a2acalling.value||0);
  outbound.value=manualOutbound+inc+q+a2aCall;
}

/* ================= SUBMIT ================= */

document.querySelector(".submit button").onclick=function(){
  if(submitted) return;
  if(!confirm("Submit & Finish Day? This cannot be edited.")) return;
  lockPage();
  saveState();
  alert("Day submitted.");
};

/* ================= CLOCK ================= */

function tick(){
  clock.textContent=
    new Date().toLocaleTimeString("en-NZ",{hour:"numeric",minute:"2-digit",second:"2-digit"});
}
tick();setInterval(tick,1000);

/* ================= INIT ================= */

checkNewDay();
loadState();
</script>
