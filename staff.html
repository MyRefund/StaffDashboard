<!-- ONLY THE <script> SECTION HAS CHANGED MEANINGFULLY -->
<script>
/* ===== CONFIG ===== */
const WORK_TYPES = [
  "Inbound","Outbound","Live Chat",
  "Emails","Unverified","A2A",
  "Delinks – SMS","Delinks – Live Chat",
  "Delinks – Phone","Delinks – Email",
  "Cancel Requests"
];

const STAFF_DATA_KEY = "myrefund_staff_data";
const BREAK_LOG_KEY = "myrefund_break_log";

/* ===== STATE ===== */
const counters = {};
const staffName = localStorage.getItem("myrefund_active_staff");
document.getElementById("staffName").textContent = staffName || "Staff";

/* ===== BUILD COUNTERS ===== */
WORK_TYPES.forEach(w=>{
  counters[w]=0;
  const el=document.createElement("div");
  el.className="counter";
  el.innerHTML=`
    <strong>${w}</strong>
    <div class="counter-controls">
      <button class="ghost" onclick="addOne('${w}')">+1</button>
      <input type="number" min="0" placeholder="0" onchange="setCount('${w}',this.value)">
    </div>
  `;
  document.getElementById("workGrid").appendChild(el);
});

function addOne(w){ counters[w]++; }
function setCount(w,v){ counters[w]=Number(v)||0; }

/* ===== LOAD NOTES + BREAKS ===== */
const staffData = JSON.parse(localStorage.getItem(STAFF_DATA_KEY)||"{}")[staffName] || {};
document.getElementById("staffNotes").textContent = staffData.notes || "No notes for today";

/* ===== BREAK HANDLING ===== */
let currentBreakTime = null;

const breaks = (staffData.breaks||"")
  .split(",")
  .map(b=>b.trim())
  .filter(Boolean);

const today = new Date().toISOString().slice(0,10);

breaks.forEach(t=>{
  const [h,m]=t.split(":");
  if(!h||!m) return;
  const breakTime = new Date(`${today}T${h}:${m}:00`);
  const delay = breakTime - Date.now();
  if(delay>0){
    setTimeout(()=>triggerBreak(t), delay);
  }
});

function triggerBreak(time){
  currentBreakTime = time;
  document.getElementById("breakSound").play();
  document.getElementById("breakPopup").style.display="flex";
  document.getElementById("statusText").textContent="On break";
}

function ackBreak(){
  // Save acknowledgement
  const log = JSON.parse(localStorage.getItem(BREAK_LOG_KEY)||"{}");
  if(!log[staffName]) log[staffName]=[];
  log[staffName].push({
    time: currentBreakTime,
    acknowledgedAt: new Date().toISOString()
  });
  localStorage.setItem(BREAK_LOG_KEY, JSON.stringify(log));

  // Reset UI
  document.getElementById("breakPopup").style.display="none";
  document.getElementById("statusText").textContent="Working";
  currentBreakTime = null;
}

/* ===== SUBMIT ===== */
function submitDay(){
  const loginTime = localStorage.getItem("myrefund_login_time");
  const minutesWorked = loginTime
    ? Math.round((Date.now()-new Date(loginTime)) / 60000)
    : 0;

  const payload = {
    activity: Object.entries(counters)
      .filter(([_,v])=>v>0)
      .map(([type,qty])=>({
        date: new Date().toISOString().slice(0,10),
        staff_id: staffName,
        staff_name: staffName,
        work_type: type,
        quantity: qty
      })),
    shift: {
      date: new Date().toISOString().slice(0,10),
      staff_id: staffName,
      staff_name: staffName,
      minutes_worked: minutesWorked
    }
  };

  fetch("https://script.google.com/macros/s/AKfycbxrteoDa30Q_uz2-O4j_HE_agEpsCl7LlnPTghyWktDp2VXykkSHjoAqeZ4Jiz3nnYJ/exec",{
    method:"POST",
    body:JSON.stringify(payload)
  }).then(()=>{
    alert("Your work has been submitted. Thank you!");
    localStorage.removeItem("myrefund_login_time");
    window.location.href="index.html";
  });
}
</script>
