<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="Content-Language" content="en">
<meta name="google" content="notranslate">

<title>My Refund — Reports</title>

<style>
:root{
  --g0:#094B35;
  --g2:#ECFDF5;
  --border:#e5e7eb;
  --text:#111827;
  --muted:#6b7280;
  --radius:16px;
  --shadow:0 12px 32px rgba(0,0,0,.12);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Okta Neue", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background:#f9fafb;
  color:var(--text);
}

/* HEADER */
.header{
  background:var(--g0);
  color:#fff;
  padding:14px 24px;
}
.header-inner{
  max-width:1400px;
  margin:0 auto;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.brand{
  display:flex;
  gap:14px;
  align-items:center;
}
.brand img{height:26px}
.brand-text{display:flex;flex-direction:column;line-height:1.1}
.brand-text strong{font-weight:900;font-size:15px}
.brand-text span{font-size:12px;opacity:.9;font-weight:700}
.header-right{
  display:flex;
  align-items:center;
  gap:14px;
}
.dashboard-btn{
  border-radius:999px;
  padding:8px 16px;
  font-weight:900;
  font-size:13px;
  border:1px solid #fff;
  background:transparent;
  color:#fff;
  cursor:pointer;
}
.clock{font-weight:900;font-size:14px}

/* TOP FILTER BAR */
.topbar{
  max-width:1400px;
  margin:20px auto 0;
  padding:16px;
  background:#fff;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  display:flex;
  flex-wrap:wrap;
  gap:14px;
  align-items:flex-end;
}

.field{
  display:flex;
  flex-direction:column;
  font-size:12px;
  font-weight:900;
  min-width:160px;
}
.field input{
  margin-top:6px;
  padding:8px 10px;
  border-radius:10px;
  border:1px solid var(--border);
  font-weight:800;
  background:#fff;
}

button.primary{
  padding:10px 18px;
  border-radius:12px;
  background:var(--g0);
  color:#fff;
  border:none;
  font-weight:900;
  cursor:pointer;
}
button.secondary{
  padding:10px 18px;
  border-radius:12px;
  background:#fff;
  border:1px solid var(--g0);
  color:var(--g0);
  font-weight:900;
  cursor:pointer;
}

.status-pill{
  padding:8px 12px;
  border-radius:999px;
  background:var(--g2);
  font-size:12px;
  font-weight:900;
  color:var(--g0);
  border:1px solid rgba(9,75,53,.12);
}

/* CONTENT */
.content{
  max-width:1400px;
  margin:20px auto 60px;
  padding:0 16px;
  display:flex;
  flex-direction:column;
  gap:18px;
}

/* SUMMARY */
.summary-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:16px;
}
.summary-card{
  background:#fff;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:18px 18px 16px;
}
.summary-card h4{
  margin:0;
  font-size:13px;
  font-weight:900;
  color:var(--muted);
}
.summary-main{
  margin-top:10px;
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:10px;
}
.summary-value{
  font-size:28px;
  font-weight:900;
  color:var(--g0);
  line-height:1;
}
.delta{
  font-size:12px;
  font-weight:900;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#fff;
  white-space:nowrap;
}
.delta.up{color:#065f46;background:#ecfdf5;border-color:rgba(6,95,70,.18)}
.delta.down{color:#7c2d12;background:#fff7ed;border-color:rgba(124,45,18,.18)}
.summary-sub{
  margin-top:10px;
  display:flex;
  justify-content:space-between;
  color:var(--muted);
  font-weight:900;
  font-size:12px;
}
.summary-sub strong{color:var(--g0)}

/* PANELS */
.panel{
  background:#fff;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:18px;
}
.panel h3{
  margin:0 0 12px;
  font-weight:900;
  color:var(--g0);
  font-size:16px;
}
.grid2{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
}
@media(max-width:980px){
  .grid2{grid-template-columns:1fr}
}

.table-wrap{overflow:auto}
table{
  width:100%;
  border-collapse:collapse;
  min-width:720px;
}
th,td{
  padding:10px 8px;
  border-bottom:1px solid var(--border);
  font-size:13px;
}
th{
  text-align:left;
  color:var(--muted);
  font-weight:900;
}
td strong{color:var(--g0)}
.right{text-align:right}
.small-muted{color:var(--muted);font-weight:800;font-size:12px}

.hr{
  height:1px;background:var(--border);margin:14px 0;
}
.note{
  font-size:12px;
  font-weight:800;
  color:var(--muted);
}
.note strong{color:var(--g0)}
</style>
</head>

<body>

<div class="header">
  <div class="header-inner">
    <div class="brand">
      <img src="logo.png" alt="My Refund">
      <div class="brand-text">
        <strong>Reports</strong>
        <span>Live overview + filters</span>
      </div>
    </div>
    <div class="header-right">
      <button class="dashboard-btn" onclick="goHome()">← Dashboard</button>
      <div class="clock" id="clock"></div>
    </div>
  </div>
</div>

<div class="topbar">
  <div class="field">
    Date From
    <input type="date" id="startDate">
  </div>

  <div class="field">
    Date To
    <input type="date" id="endDate">
  </div>

  <button class="primary" id="runBtn">Run Report</button>
  <button class="secondary" id="pdfBtn">Download PDF</button>

  <div class="status-pill" id="statusPill">Live Today</div>
</div>

<div class="content">

  <div class="summary-grid">

    <div class="summary-card">
      <h4>Client Touchpoints</h4>
      <div class="summary-main">
        <div class="summary-value" id="touchpointsToday">0</div>
        <div class="delta" id="touchpointsDelta">—</div>
      </div>
      <div class="summary-sub">
        <span>Yesterday: <strong id="touchpointsYday">0</strong></span>
        <span class="small-muted">CSR only</span>
      </div>
    </div>

    <div class="summary-card">
      <h4>Returns Processed</h4>
      <div class="summary-main">
        <div class="summary-value" id="returnsToday">0</div>
        <div class="delta" id="returnsDelta">—</div>
      </div>
      <div class="summary-sub">
        <span>Yesterday: <strong id="returnsYday">0</strong></span>
        <span class="small-muted">Processing only</span>
      </div>
    </div>

    <div class="summary-card">
      <h4>Revenue (Fees)</h4>
      <div class="summary-main">
        <div class="summary-value" id="feesToday">$0</div>
        <div class="delta" id="feesDelta">—</div>
      </div>
      <div class="summary-sub">
        <span>Yesterday: <strong id="feesYday">$0</strong></span>
        <span class="small-muted">Processing only</span>
      </div>
    </div>

  </div>

</div>

</body>
</html>
<script>
/* ===========================
   CONFIG
=========================== */
const WEB_APP_URL =
  "https://script.google.com/macros/s/AKfycbwCZTuvnbwTAfkDXMjbLzCR-YXkzcbQ-hujbrZW7Hib5iLhbVwfkJ1xmSfpu-YfRGTn/exec";

const TZ = "Pacific/Auckland";

/* ===========================
   NAV / CLOCK
=========================== */
function goHome(){ window.location.href="index.html"; }

(function tick(){
  const el = document.getElementById("clock");
  if(el){
    el.textContent = new Date().toLocaleTimeString("en-NZ",{
      hour:"numeric",minute:"2-digit",second:"2-digit"
    });
  }
  setTimeout(tick,1000);
})();

/* ===========================
   DATE HELPERS (NZ)
=========================== */
function nzISO(d=new Date()){
  return d.toLocaleDateString("en-CA",{timeZone:TZ});
}
function addDaysISO(iso,delta){
  const [y,m,dd]=iso.split("-").map(Number);
  const dt=new Date(Date.UTC(y,m-1,dd));
  dt.setUTCDate(dt.getUTCDate()+delta);
  return nzISO(new Date(dt));
}
function parseAsISO(v){
  // Accepts Date, ISO, or anything-ish; returns YYYY-MM-DD where possible.
  if(!v) return "";
  if(typeof v === "string"){
    // If already ISO-ish
    if(/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
    // Try Date parse
    const d = new Date(v);
    if(!isNaN(d)) return nzISO(d);
    return "";
  }
  if(v instanceof Date && !isNaN(v)) return nzISO(v);
  return "";
}

/* ===========================
   FORMATTERS
=========================== */
function money(n){
  const v = Number(n)||0;
  return "$" + v.toLocaleString("en-NZ",{minimumFractionDigits:2,maximumFractionDigits:2});
}
function pctChange(today, yday){
  const t = Number(today)||0;
  const y = Number(yday)||0;
  if(y===0 && t===0) return {text:"—", cls:""};
  if(y===0 && t>0) return {text:"+∞", cls:"up"};
  const p = ((t-y)/y)*100;
  const sign = p>0?"+":"";
  return {text:`${sign}${p.toFixed(0)}%`, cls: p>=0 ? "up" : "down"};
}
function formatDelta(el, today, yday){
  const p = pctChange(today, yday);
  el.classList.remove("up","down");
  if(p.cls) el.classList.add(p.cls);
  el.textContent = p.text;
}

/* ===========================
   UI HELPERS
=========================== */
function setStatus(text){
  const pill = document.getElementById("statusPill");
  if(pill) pill.textContent = text;
}
function safeNum(v){
  const n = Number(v);
  return isFinite(n) ? n : 0;
}

/* ===========================
   FETCH BACKEND DATA
   - expects Apps Script action=getReportData
   - returns { ok:true, csr:[...], processing:[...], fees:[...] }
=========================== */
async function fetchReportData(){
  const url = WEB_APP_URL + "?action=getReportData";
  const res = await fetch(url, { method:"GET" });
  const data = await res.json();
  if(!data || !data.ok) throw new Error((data && data.error) ? data.error : "Backend error");
  return data;
}

/* ===========================
   FILTERING (BY DATE RANGE)
=========================== */
function withinRange(iso, startISO, endISO){
  if(!iso) return false;
  return iso >= startISO && iso <= endISO;
}

function filterByDate(rows, dateField, startISO, endISO){
  return (rows||[]).filter(r=>{
    const iso = parseAsISO(r[dateField]);
    return withinRange(iso, startISO, endISO);
  });
}

/* ===========================
   AGGREGATION
   Sheets headers you gave:
   CSR_Log: expects Inbound / Outbound / Chat
   Processing_Log: expects Total Output / Total Fees
   Fee_Log: expects Date / Fee_Type / Count / Total_Fee
=========================== */
function sumCSRTouchpoints(csrRows){
  let touch = 0;
  for(const r of csrRows){
    touch += safeNum(r["Inbound"]) + safeNum(r["Outbound"]) + safeNum(r["Chat"]);
  }
  return touch;
}

function sumProcessingOutput(procRows){
  let out = 0;
  for(const r of procRows){
    // Prefer header "Total Output" but also accept "TotalOutput"
    out += safeNum(r["Total Output"] ?? r["TotalOutput"]);
  }
  return out;
}

function sumFeesFromProcessing(procRows){
  let fees = 0;
  for(const r of procRows){
    // Prefer header "Total Fees" but also accept "TotalFees"
    fees += safeNum(r["Total Fees"] ?? r["TotalFees"]);
  }
  return Math.round(fees * 100) / 100;
}

function sumFeesFromFeeLog(feeRows){
  // Fee_Log rows are aggregated by type per submission in your script:
  // columns: Timestamp, Date, Staff, Fee_Type, Count, Total_Fee
  let total = 0;
  for(const r of feeRows){
    total += safeNum(r["Total_Fee"] ?? r["Total Fee"] ?? r["TotalFee"]);
  }
  return Math.round(total * 100) / 100;
}

/* ===========================
   MAIN REPORT
=========================== */
async function runReport(){
  try{
    setStatus("Loading…");

    const startISO = document.getElementById("startDate").value || nzISO();
    const endISO   = document.getElementById("endDate").value || nzISO();

    // For deltas we use start date as “day view” (matches your earlier approach)
    const dayISO  = startISO;
    const ydayISO = addDaysISO(dayISO, -1);

    const data = await fetchReportData();

    // Filter by date range for display totals
    const csrInRange  = filterByDate(data.csr, "Date", startISO, endISO);
    const procInRange = filterByDate(data.processing, "Date", startISO, endISO);
    const feeInRange  = filterByDate(data.fees, "Date", startISO, endISO);

    // Day vs yesterday for deltas (single-day compare)
    const csrDay  = filterByDate(data.csr, "Date", dayISO, dayISO);
    const csrYday = filterByDate(data.csr, "Date", ydayISO, ydayISO);

    const procDay  = filterByDate(data.processing, "Date", dayISO, dayISO);
    const procYday = filterByDate(data.processing, "Date", ydayISO, ydayISO);

    const feeDay  = filterByDate(data.fees, "Date", dayISO, dayISO);
    const feeYday = filterByDate(data.fees, "Date", ydayISO, ydayISO);

    // Totals (today card values use dayISO; if you want range totals shown instead, tell me)
    const touchToday = sumCSRTouchpoints(csrDay);
    const touchYday  = sumCSRTouchpoints(csrYday);

    const returnsToday = sumProcessingOutput(procDay);
    const returnsYday  = sumProcessingOutput(procYday);

    // Fees: prefer Fee_Log (it’s the most accurate breakdown), fallback to Processing_Log totals
    let feesToday = sumFeesFromFeeLog(feeDay);
    if(feesToday === 0) feesToday = sumFeesFromProcessing(procDay);

    let feesYday = sumFeesFromFeeLog(feeYday);
    if(feesYday === 0) feesYday = sumFeesFromProcessing(procYday);

    // Update UI
    document.getElementById("touchpointsToday").textContent = touchToday.toLocaleString("en-NZ");
    document.getElementById("touchpointsYday").textContent  = touchYday.toLocaleString("en-NZ");
    formatDelta(document.getElementById("touchpointsDelta"), touchToday, touchYday);

    document.getElementById("returnsToday").textContent = returnsToday.toLocaleString("en-NZ");
    document.getElementById("returnsYday").textContent  = returnsYday.toLocaleString("en-NZ");
    formatDelta(document.getElementById("returnsDelta"), returnsToday, returnsYday);

    document.getElementById("feesToday").textContent = money(feesToday);
    document.getElementById("feesYday").textContent  = money(feesYday);
    formatDelta(document.getElementById("feesDelta"), feesToday, feesYday);

    // Status
    setStatus("Live Data");

  }catch(err){
    console.error(err);
    alert(err && err.message ? err.message : "Connection error");
    setStatus("Connection error");
  }
}

/* ===========================
   PDF (placeholder)
=========================== */
function downloadPDF(){
  alert("PDF export will match current filters when it is wired.");
}

/* ===========================
   INIT
=========================== */
(function init(){
  const todayISO = nzISO();
  const s = document.getElementById("startDate");
  const e = document.getElementById("endDate");
  if(s && !s.value) s.value = todayISO;
  if(e && !e.value) e.value = todayISO;

  const runBtn = document.getElementById("runBtn");
  if(runBtn) runBtn.addEventListener("click", runReport);

  const pdfBtn = document.getElementById("pdfBtn");
  if(pdfBtn) pdfBtn.addEventListener("click", downloadPDF);

  runReport();
})();
</script>
