<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>My Refund – Reports</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
@font-face { font-family:'Okta Neue'; src: local('Okta Neue'); }
:root{
  --green-dark:#094B35;
  --green:#03953F;
  --green-soft:#ECFDF5;
  --border:#e5e7eb;
  --text:#111827;
  --muted:#6b7280;
  --bg:#f6f7f8;
}
*{box-sizing:border-box}
body{margin:0;font-family:'Okta Neue',system-ui,sans-serif;background:var(--bg);color:var(--text)}
header{display:flex;align-items:center;justify-content:space-between;padding:16px 24px;background:#fff;border-bottom:1px solid var(--border)}
header img{max-width:150px}
main{max-width:1200px;margin:0 auto;padding:24px}
h1,h2,h3{color:var(--green-dark);margin:0 0 10px}
.card{background:#fff;border-radius:16px;padding:16px;margin-bottom:16px}
.notice{background:var(--green-soft);color:var(--green-dark);padding:12px;border-radius:14px;font-weight:900}
.muted{color:var(--muted);font-size:12px}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1;min-width:260px}
input,button{font-family:inherit}
input[type="date"]{padding:8px 10px;border:1px solid var(--border);border-radius:10px;width:100%}
button{padding:9px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;font-weight:900;cursor:pointer}
button.primary{background:var(--green-dark);color:#fff;border-color:var(--green-dark)}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
.hidden{display:none}
</style>
</head>
<body>

<header>
  <img src="logo.png" alt="My Refund">
  <div class="muted">Reports (Read-only)</div>
</header>

<main>

<h1>Daily Reports</h1>

<div class="card">
  <input type="date" id="reportDate">
  <button class="primary" onclick="runReport()">Run</button>
</div>

<div class="card">
  <h3>Team totals</h3>
  <table>
    <thead>
      <tr>
        <th>Work type</th>
        <th>Starting</th>
        <th>Completed</th>
        <th>Remaining</th>
      </tr>
    </thead>
    <tbody id="teamTotals"></tbody>
  </table>
</div>

<div class="card">
  <h3>Individual productivity</h3>
  <table>
    <thead>
      <tr>
        <th>Staff</th>
        <th>Hours worked</th>
        <th>Total interactions</th>
        <th>Avg interaction time (min)</th>
        <th>Interactions / hour</th>
      </tr>
    </thead>
    <tbody id="staffTotals"></tbody>
  </table>
</div>

<script>
const SHEET_ID = "PASTE_YOUR_SHEET_ID_HERE";
const TAB_ACTIVITY = "activity_log";
const TAB_SHIFTS = "shifts";
const TAB_START = "starting_volumes";

function gviz(sheet){
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${sheet}`;
}

async function fetchTab(sheet){
  const res = await fetch(gviz(sheet));
  const txt = await res.text();
  const json = txt.substring(txt.indexOf("{"), txt.lastIndexOf("}")+1);
  return JSON.parse(json).table;
}

function toObjects(table){
  const cols = table.cols.map(c=>c.label);
  return (table.rows||[]).map(r=>{
    const o={};
    r.c.forEach((cell,i)=>{
      let v = cell ? cell.v : "";
      if(typeof v==="string" && v.startsWith("Date(")){
        const p=v.replace("Date(","").replace(")","").split(",");
        v=`${p[0]}-${String(+p[1]+1).padStart(2,"0")}-${String(p[2]).padStart(2,"0")}`;
      }
      o[cols[i]]=v;
    });
    return o;
  });
}

async function runReport(){
  const date=document.getElementById("reportDate").value;
  if(!date) return alert("Pick a date");

  const activity=toObjects(await fetchTab(TAB_ACTIVITY));
  const shifts=toObjects(await fetchTab(TAB_SHIFTS));
  const starts=toObjects(await fetchTab(TAB_START));

  const completed={};
  const interactions={};
  activity.filter(r=>r.date===date).forEach(r=>{
    const q=Number(r.quantity)||0;
    completed[r.work_type]=(completed[r.work_type]||0)+q;
    interactions[r.staff_id]=(interactions[r.staff_id]||0)+q;
  });

  const starting={};
  starts.filter(r=>r.date===date).forEach(r=>{
    starting[r.work_type]=Number(r.starting_volume)||0;
  });

  const team=document.getElementById("teamTotals");
  team.innerHTML="";
  const workTypes=new Set([...Object.keys(starting),...Object.keys(completed)]);
  workTypes.forEach(w=>{
    const s=starting[w]||0;
    const c=completed[w]||0;
    const r=Math.max(0,s-c);
    team.innerHTML+=`<tr><td>${w}</td><td>${s||"—"}</td><td>${c}</td><td>${s? r:"—"}</td></tr>`;
  });

  const staffTable=document.getElementById("staffTotals");
  staffTable.innerHTML="";
  shifts.filter(r=>r.date===date).forEach(r=>{
    const mins=Number(r.minutes_worked)||0;
    const hours=mins/60;
    const ints=interactions[r.staff_id]||0;
    const avg=ints?(mins/ints).toFixed(1):"—";
    const iph=hours?(ints/hours).toFixed(1):"—";
    staffTable.innerHTML+=`
      <tr>
        <td>${r.staff_name}</td>
        <td>${hours.toFixed(2)}</td>
        <td>${ints}</td>
        <td>${avg}</td>
        <td>${iph}</td>
      </tr>`;
  });
}
</script>

</body>
</html>
