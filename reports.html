<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>My Refund – Reports</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
@font-face { font-family:'Okta Neue'; src: local('Okta Neue'); }
:root{
  --green-dark:#094B35;
  --green:#03953F;
  --green-soft:#ECFDF5;
  --border:#e5e7eb;
  --text:#111827;
  --muted:#6b7280;
  --bg:#f6f7f8;
}
*{box-sizing:border-box}
body{margin:0;font-family:'Okta Neue',system-ui,sans-serif;background:var(--bg);color:var(--text)}
header{display:flex;align-items:center;justify-content:space-between;padding:16px 24px;background:#fff;border-bottom:1px solid var(--border)}
header img{max-width:150px}
main{max-width:1200px;margin:0 auto;padding:24px}
h1,h2,h3{color:var(--green-dark);margin:0 0 10px}
.card{background:#fff;border-radius:16px;padding:16px;margin-bottom:16px}
.notice{background:var(--green-soft);color:var(--green-dark);padding:12px;border-radius:14px;font-weight:900}
.muted{color:var(--muted);font-size:12px}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1;min-width:260px}
input,select,button{font-family:inherit}
input[type="date"],input[type="month"],select{padding:8px 10px;border:1px solid var(--border);border-radius:10px;width:100%}
button{padding:9px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;font-weight:900;cursor:pointer}
button.primary{background:var(--green-dark);color:#fff;border-color:var(--green-dark)}
.tabs{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
.tab{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;font-weight:900;cursor:pointer}
.tab.active{background:var(--green-dark);color:#fff;border-color:var(--green-dark)}
.section{display:none}
.section.active{display:block}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
.hidden{display:none}
</style>
</head>
<body>

<header>
  <img src="logo.png" alt="My Refund">
  <div class="muted">Reports (Read-only)</div>
</header>

<main>

<div id="loginView">
  <h1>Reports</h1>
  <div class="card">
    <div class="notice">Admin access</div>
    <p class="muted">Select your name to open reports.</p>
    <select id="adminSelect">
      <option>Drew</option>
    </select>
    <br><br>
    <button class="primary" onclick="login()">Open reports</button>
  </div>
</div>

<div id="appView" class="hidden">
  <h1>Reports</h1>
  <div class="tabs">
    <div class="tab active" onclick="showTab('daily')">Daily</div>
  </div>

  <section id="daily" class="section active">
    <div class="card">
      <input type="date" id="dailyDate">
      <button class="primary" onclick="runDaily()">Run</button>
    </div>
    <div class="card">
      <h3>Team totals</h3>
      <table><tbody id="dailyTeam"></tbody></table>
    </div>
    <div class="card">
      <h3>Individual productivity</h3>
      <table><tbody id="dailyStaff"></tbody></table>
    </div>
  </section>
</div>

</main>

<script>
const SHEET_ID = "1L_jvj8ve-8qdX61Yk0admNdoqJG1fDBTBViqiHRxif0";
const TAB_ACTIVITY = "activity_log";
const TAB_SHIFTS = "shifts";

function gvizUrl(sheet){
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${sheet}`;
}

async function fetchSheet(sheet){
  const res = await fetch(gvizUrl(sheet));
  const txt = await res.text();
  const json = txt.substring(txt.indexOf("{"), txt.lastIndexOf("}")+1);
  return JSON.parse(json).table;
}

function tableToObjects(table){
  const cols = table.cols.map(c=>c.label);
  return (table.rows||[]).map(r=>{
    const o={};
    r.c.forEach((cell,i)=>{
      let v = cell ? cell.v : "";
      if(typeof v==="string" && v.startsWith("Date(")){
        const p=v.replace("Date(","").replace(")","").split(",");
        v=`${p[0]}-${String(+p[1]+1).padStart(2,"0")}-${String(p[2]).padStart(2,"0")}`;
      }
      o[cols[i]]=v;
    });
    return o;
  });
}

function sheetTimeToMinutes(v){
  if(typeof v==="number") return v*1440;
  if(typeof v==="string" && v.includes(":")){
    const [h,m]=v.split(":").map(Number);
    return h*60+m;
  }
  return 0;
}

function login(){
  document.getElementById("loginView").classList.add("hidden");
  document.getElementById("appView").classList.remove("hidden");
}

function showTab(id){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  document.querySelector(`.tab[onclick="showTab('${id}')"]`).classList.add("active");
  document.getElementById(id).classList.add("active");
}

async function runDaily(){
  const date=document.getElementById("dailyDate").value;
  const act=tableToObjects(await fetchSheet(TAB_ACTIVITY));
  const sh=tableToObjects(await fetchSheet(TAB_SHIFTS));

  const totals={};
  const staff={};

  act.filter(r=>r.date===date).forEach(r=>{
    totals[r.work_type]=(totals[r.work_type]||0)+Number(r.quantity||0);
    staff[r.staff_id]=(staff[r.staff_id]||0)+Number(r.quantity||0);
  });

  const team=document.getElementById("dailyTeam");
  team.innerHTML="";
  Object.keys(totals).forEach(k=>{
    team.innerHTML+=`<tr><td>${k}</td><td>${totals[k]}</td></tr>`;
  });

  const staffTable=document.getElementById("dailyStaff");
  staffTable.innerHTML="";
  sh.filter(r=>r.date===date).forEach(r=>{
    const mins=sheetTimeToMinutes(r.finish_time)-sheetTimeToMinutes(r.start_time)-(Number(r.break_minutes)||0);
    const hrs=(mins/60).toFixed(2);
    const inter=staff[r.staff_id]||0;
    const avg=inter?(mins/inter).toFixed(1):"—";
    staffTable.innerHTML+=`<tr><td>${r.staff_name}</td><td>${hrs}</td><td>${inter}</td><td>${avg}</td></tr>`;
  });
}

</script>
</body>
</html>
