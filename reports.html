<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>My Refund — Reports</title>

<style>
:root{
  --g0:#094B35;
  --g2:#ECFDF5;
  --border:#e5e7eb;
  --text:#111827;
  --muted:#6b7280;
  --radius:16px;
  --shadow:0 12px 32px rgba(0,0,0,.12);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Okta Neue",system-ui;
  background:#f9fafb;
  color:var(--text);
}

/* HEADER */
.header{
  background:var(--g0);
  color:#fff;
  padding:14px 24px;
}
.header-inner{
  max-width:1400px;
  margin:0 auto;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.dashboard-btn{
  border-radius:999px;
  padding:8px 16px;
  font-weight:900;
  font-size:13px;
  border:1px solid #fff;
  background:transparent;
  color:#fff;
  cursor:pointer;
}
.clock{font-weight:900;font-size:14px}

/* FILTER COLUMN */
.layout{
  max-width:1400px;
  margin:20px auto;
  display:grid;
  grid-template-columns:280px 1fr;
  gap:20px;
  padding:0 16px;
}
.filters{
  background:#fff;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:20px;
}
.filters h3{
  margin-top:0;
  color:var(--g0);
}
.filters label{
  font-size:12px;
  font-weight:900;
  display:block;
  margin-top:14px;
}
.filters input,
.filters select{
  width:100%;
  margin-top:6px;
  padding:8px 10px;
  border-radius:10px;
  border:1px solid var(--border);
  font-weight:800;
}
.filters button{
  margin-top:18px;
  width:100%;
  padding:10px;
  background:var(--g0);
  color:#fff;
  border:none;
  border-radius:12px;
  font-weight:900;
  cursor:pointer;
}

/* CONTENT */
.content{
  display:flex;
  flex-direction:column;
  gap:18px;
}
.summary-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:16px;
}
.summary-card{
  background:#fff;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:18px;
}
.summary-card h4{
  margin:0;
  font-size:13px;
  font-weight:900;
  color:var(--muted);
}
.summary-value{
  margin-top:10px;
  font-size:28px;
  font-weight:900;
  color:var(--g0);
}

.panel{
  background:#fff;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:18px;
}
.panel h3{
  margin-top:0;
  color:var(--g0);
}
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:8px;
  border-bottom:1px solid var(--border);
  font-size:13px;
}
th{
  text-align:left;
  color:var(--muted);
  font-weight:900;
}
.right{text-align:right}
.small-muted{color:var(--muted);font-weight:800;font-size:12px}
.status-pill{
  padding:8px 12px;
  border-radius:999px;
  background:var(--g2);
  font-size:12px;
  font-weight:900;
  color:var(--g0);
  display:inline-block;
  margin-top:10px;
}
</style>
</head>

<body>

<div class="header">
  <div class="header-inner">
    <div><strong>Reports</strong></div>
    <div>
      <button class="dashboard-btn" onclick="window.location.href='index.html'">← Dashboard</button>
      <span class="clock" id="clock"></span>
    </div>
  </div>
</div>

<div class="layout">

<!-- LEFT FILTERS -->
<div class="filters">
  <h3>Filters</h3>

  <label>Date From</label>
  <input type="date" id="startDate">

  <label>Date To</label>
  <input type="date" id="endDate">

  <label>Division</label>
  <select id="divisionFilter" multiple></select>

  <label>Staff</label>
  <select id="staffFilter" multiple></select>

  <label>Fee Type</label>
  <select id="feeFilter" multiple></select>

  <button onclick="runReport()">Run Report</button>

  <div class="status-pill" id="statusPill">Loading…</div>
</div>

<!-- RIGHT CONTENT -->
<div class="content">

<div class="summary-grid">
  <div class="summary-card">
    <h4>Client Touchpoints</h4>
    <div class="summary-value" id="touchpointsTotal">0</div>
  </div>

  <div class="summary-card">
    <h4>Returns Processed</h4>
    <div class="summary-value" id="returnsTotal">0</div>
  </div>

  <div class="summary-card">
    <h4>Revenue</h4>
    <div class="summary-value" id="feesTotal">$0.00</div>
  </div>

  <div class="summary-card">
    <h4>Active Staff</h4>
    <div class="summary-value" id="activeStaffTotal">0</div>
  </div>
</div>

<div class="panel">
  <h3>CSR Activity</h3>
  <table>
    <thead>
      <tr>
        <th>Staff</th>
        <th class="right">Inbound</th>
        <th class="right">Outbound</th>
        <th class="right">Chat</th>
        <th class="right">Emails</th>
      </tr>
    </thead>
    <tbody id="csrTable"></tbody>
  </table>
</div>

<div class="panel">
  <h3>Processing Output</h3>
  <table>
    <thead>
      <tr>
        <th>Staff</th>
        <th class="right">Total Output</th>
        <th class="right">Fees</th>
      </tr>
    </thead>
    <tbody id="processingTable"></tbody>
  </table>
</div>

<div class="panel">
  <h3>Fee Breakdown</h3>
  <table>
    <thead>
      <tr>
        <th>Fee Type</th>
        <th class="right">Count</th>
        <th class="right">Total</th>
      </tr>
    </thead>
    <tbody id="feeTable"></tbody>
  </table>
</div>

</div>
</div>

<script>
const WEB_APP_URL="https://script.google.com/macros/s/AKfycbwCZTuvnbwTAfkDXMjbLzCR-YXkzcbQ-hujbrZW7Hib5iLhbVwfkJ1xmSfpu-YfRGTn/exec";

(function tick(){
  document.getElementById("clock").textContent=
  new Date().toLocaleTimeString("en-NZ",{hour:"numeric",minute:"2-digit",second:"2-digit"});
  setTimeout(tick,1000);
})();

const today=new Date().toISOString().split("T")[0];
document.getElementById("startDate").value=today;
document.getElementById("endDate").value=today;

function money(n){
  return "$"+Number(n||0).toLocaleString("en-NZ",{minimumFractionDigits:2});
}

async function loadFilters(){
  const res=await fetch(WEB_APP_URL+"?action=getReportData");
  const data=await res.json();

  const staff=document.getElementById("staffFilter");
  staff.innerHTML="";
  data.allStaff.forEach(s=>{
    staff.innerHTML+=`<option selected>${s}</option>`;
  });

  const div=document.getElementById("divisionFilter");
  div.innerHTML="";
  ["CSR","Processing"].forEach(d=>{
    div.innerHTML+=`<option selected>${d}</option>`;
  });

  const fee=document.getElementById("feeFilter");
  fee.innerHTML="";
  data.allFeeTypes.forEach(f=>{
    fee.innerHTML+=`<option selected>${f}</option>`;
  });

  runReport();
}

async function runReport(){

  document.getElementById("statusPill").textContent="Loading…";

  const start=new Date(document.getElementById("startDate").value);
  const end=new Date(document.getElementById("endDate").value);
  end.setHours(23,59,59,999);

  const selStaff=Array.from(staffFilter.selectedOptions).map(o=>o.value);
  const selDiv=Array.from(divisionFilter.selectedOptions).map(o=>o.value);
  const selFee=Array.from(feeFilter.selectedOptions).map(o=>o.value);

  const res=await fetch(WEB_APP_URL+"?action=getReportData");
  const data=await res.json();

  const csr=data.csr.filter(r=>{
    const d=new Date(r.Date);
    return selDiv.includes("CSR")&&selStaff.includes(r.Staff)&&d>=start&&d<=end;
  });

  const proc=data.processing.filter(r=>{
    const d=new Date(r.Date);
    return selDiv.includes("Processing")&&selStaff.includes(r.Staff)&&d>=start&&d<=end;
  });

  const fees=data.fees.filter(r=>{
    const d=new Date(r.Date);
    return selStaff.includes(r.Staff)&&selFee.includes(r.Fee_Type)&&d>=start&&d<=end;
  });

  let touch=0;
  csr.forEach(r=>{
    touch+=Number(r.Inbound||0)+Number(r.Outbound||0)+Number(r.Chat||0);
  });

  let returns=0;
  proc.forEach(r=>{
    returns+=Number(r["Total Output"]||0);
  });

  let feeTotal=0;
  fees.forEach(r=>{
    feeTotal+=Number(r.Total_Fee||0);
  });

  const active=new Set([...csr.map(r=>r.Staff),...proc.map(r=>r.Staff)]);

  touchpointsTotal.textContent=touch;
  returnsTotal.textContent=returns;
  feesTotal.textContent=money(feeTotal);
  activeStaffTotal.textContent=active.size;

  document.getElementById("statusPill").textContent="Live Data";
}

loadFilters();
</script>

</body>
</html>
