<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="Content-Language" content="en">
<meta name="google" content="notranslate">

<title>My Refund — Reports</title>

<style>
:root{
  --g0:#094B35;
  --g2:#ECFDF5;
  --border:#e5e7eb;
  --text:#111827;
  --muted:#6b7280;
  --radius:16px;
  --shadow:0 12px 32px rgba(0,0,0,.12);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Okta Neue", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background:#f9fafb;
  color:var(--text);
}

/* HEADER */
.header{
  background:var(--g0);
  color:#fff;
  padding:14px 24px;
}
.header-inner{
  max-width:1400px;
  margin:0 auto;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.brand{
  display:flex;
  gap:14px;
  align-items:center;
}
.brand img{height:26px}
.brand-text{display:flex;flex-direction:column;line-height:1.1}
.brand-text strong{font-weight:900;font-size:15px}
.brand-text span{font-size:12px;opacity:.9;font-weight:700}
.header-right{
  display:flex;
  align-items:center;
  gap:14px;
}
.dashboard-btn{
  border-radius:999px;
  padding:8px 16px;
  font-weight:900;
  font-size:13px;
  border:1px solid #fff;
  background:transparent;
  color:#fff;
  cursor:pointer;
}
.clock{font-weight:900;font-size:14px}

/* LAYOUT */
.wrap{
  max-width:1400px;
  margin:20px auto 60px;
  padding:0 16px;
}
.layout{
  display:grid;
  grid-template-columns:320px 1fr;
  gap:16px;
  align-items:start;
}
@media(max-width:1060px){
  .layout{grid-template-columns:1fr}
}

/* SIDEBAR FILTERS */
.sidebar{
  background:#fff;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:16px;
  position:sticky;
  top:16px;
}
@media(max-width:1060px){
  .sidebar{position:static}
}
.sidebar h3{
  margin:0 0 10px;
  font-weight:900;
  color:var(--g0);
  font-size:16px;
}
.field{
  display:flex;
  flex-direction:column;
  font-size:12px;
  font-weight:900;
  margin-top:12px;
}
.field input{
  margin-top:6px;
  padding:8px 10px;
  border-radius:10px;
  border:1px solid var(--border);
  font-weight:800;
  background:#fff;
}
.section{
  margin-top:14px;
  padding-top:12px;
  border-top:1px solid var(--border);
}
.section-title{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin:0 0 10px;
  color:var(--g0);
  font-weight:900;
  font-size:13px;
}
.pill{
  padding:6px 10px;
  border-radius:999px;
  background:var(--g2);
  font-size:11px;
  font-weight:900;
  color:var(--g0);
  border:1px solid rgba(9,75,53,.12);
  white-space:nowrap;
}
.checklist{
  display:flex;
  flex-direction:column;
  gap:8px;
  max-height:220px;
  overflow:auto;
  padding-right:6px;
}
.check{
  display:flex;
  align-items:center;
  gap:10px;
  padding:8px 10px;
  border:1px solid var(--border);
  border-radius:12px;
  cursor:pointer;
  user-select:none;
}
.check:hover{background:#f3f4f6}
.check input{transform:scale(1.05)}
.check strong{font-size:13px}
.small-muted{color:var(--muted);font-weight:800;font-size:12px}

.actions{
  margin-top:14px;
  display:flex;
  gap:10px;
}
button.primary{
  flex:1;
  padding:10px 14px;
  border-radius:12px;
  background:var(--g0);
  color:#fff;
  border:none;
  font-weight:900;
  cursor:pointer;
}
button.secondary{
  padding:10px 14px;
  border-radius:12px;
  background:#fff;
  border:1px solid var(--g0);
  color:var(--g0);
  font-weight:900;
  cursor:pointer;
}

/* STATUS */
.status-pill{
  margin-top:12px;
  padding:10px 12px;
  border-radius:14px;
  background:var(--g2);
  font-size:12px;
  font-weight:900;
  color:var(--g0);
  border:1px solid rgba(9,75,53,.12);
}

/* MAIN CONTENT */
.content{
  display:flex;
  flex-direction:column;
  gap:16px;
}

.summary-grid{
  display:grid;
  grid-template-columns:repeat(3,minmax(240px,1fr));
  gap:16px;
}
@media(max-width:980px){
  .summary-grid{grid-template-columns:1fr}
}
.summary-card{
  background:#fff;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:18px 18px 16px;
}
.summary-card h4{
  margin:0;
  font-size:13px;
  font-weight:900;
  color:var(--muted);
}
.summary-main{
  margin-top:10px;
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:10px;
}
.summary-value{
  font-size:28px;
  font-weight:900;
  color:var(--g0);
  line-height:1;
}
.delta{
  font-size:12px;
  font-weight:900;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#fff;
  white-space:nowrap;
}
.delta.up{color:#065f46;background:#ecfdf5;border-color:rgba(6,95,70,.18)}
.delta.down{color:#7c2d12;background:#fff7ed;border-color:rgba(124,45,18,.18)}
.summary-sub{
  margin-top:10px;
  display:flex;
  justify-content:space-between;
  color:var(--muted);
  font-weight:900;
  font-size:12px;
}
.summary-sub strong{color:var(--g0)}

.panel{
  background:#fff;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:18px;
}
.panel h3{
  margin:0 0 12px;
  font-weight:900;
  color:var(--g0);
  font-size:16px;
}
.hr{height:1px;background:var(--border);margin:14px 0;}

.grid2{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
}
@media(max-width:980px){
  .grid2{grid-template-columns:1fr}
}

.table-wrap{overflow:hidden;} /* key: no sideways scroll */
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:10px 8px;
  border-bottom:1px solid var(--border);
  font-size:13px;
  vertical-align:top;
}
th{
  text-align:left;
  color:var(--muted);
  font-weight:900;
}
td strong{color:var(--g0)}
.right{text-align:right}

.note{
  font-size:12px;
  font-weight:800;
  color:var(--muted);
  line-height:1.5;
}
.note strong{color:var(--g0)}

.badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  font-size:12px;
  font-weight:900;
  color:var(--g0);
  background:var(--g2);
}
.dot{
  width:8px;height:8px;border-radius:50%;
  background:#16a34a;
}
.dot.warn{background:#f59e0b}
.dot.bad{background:#dc2626}

/* compact row cards (mobile-friendly, no sideways scroll) */
@media(max-width:720px){
  th{display:none}
  tr{display:block;border-bottom:1px solid var(--border)}
  td{display:flex;justify-content:space-between;gap:10px;border:none;padding:8px 0}
  td::before{
    content:attr(data-label);
    color:var(--muted);
    font-weight:900;
  }
  td.right{text-align:left}
}
</style>
</head>

<body>

<div class="header">
  <div class="header-inner">
    <div class="brand">
      <img src="logo.png" alt="My Refund">
      <div class="brand-text">
        <strong>Reports</strong>
        <span>Live overview + filters</span>
      </div>
    </div>

    <div class="header-right">
      <button class="dashboard-btn" onclick="goHome()">← Dashboard</button>
      <div class="clock" id="clock"></div>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="layout">

    <!-- LEFT: FILTERS -->
    <div class="sidebar">
      <h3>Filters</h3>

      <div class="field">
        Date From
        <input type="date" id="startDate">
      </div>

      <div class="field">
        Date To
        <input type="date" id="endDate">
      </div>

      <div class="section">
        <div class="section-title">
          <span>Division</span>
          <span class="pill" id="divCount">2 selected</span>
        </div>
        <div class="checklist" id="divisionChecks"></div>
      </div>

      <div class="section">
        <div class="section-title">
          <span>Staff (all)</span>
          <span class="pill" id="staffCountPill">All</span>
        </div>

        <div class="small-muted" style="margin-bottom:8px;">CSR staff</div>
        <div class="checklist" id="staffChecksCSR"></div>

        <div class="small-muted" style="margin:12px 0 8px;">Processing staff</div>
        <div class="checklist" id="staffChecksProcessing"></div>

        <div class="small-muted" style="margin-top:10px;">Tip: leave staff blank to include everyone.</div>
      </div>

      <div class="section">
        <div class="section-title">
          <span>Fee Type (all)</span>
          <span class="pill" id="feeCountPill">All</span>
        </div>
        <div class="checklist" id="feeChecks"></div>
        <div class="small-muted" style="margin-top:10px;">Tip: leave fee types blank to include all fees.</div>
      </div>

      <div class="actions">
        <button class="primary" id="runBtn" onclick="runReport()">Apply Filters</button>
        <button class="secondary" onclick="downloadPDF()">PDF</button>
      </div>

      <div class="status-pill" id="statusPill">Ready</div>
    </div>

    <!-- RIGHT: REPORT -->
    <div class="content">

      <!-- EXEC SNAPSHOT (Active Staff removed as requested) -->
      <div class="summary-grid">
        <div class="summary-card">
          <h4>Client Touchpoints</h4>
          <div class="summary-main">
            <div class="summary-value" id="touchpointsToday">0</div>
            <div class="delta" id="touchpointsDelta">—</div>
          </div>
          <div class="summary-sub">
            <span>Yesterday: <strong id="touchpointsYday">0</strong></span>
            <span class="small-muted">CSR only</span>
          </div>
        </div>

        <div class="summary-card">
          <h4>Returns Processed</h4>
          <div class="summary-main">
            <div class="summary-value" id="returnsToday">0</div>
            <div class="delta" id="returnsDelta">—</div>
          </div>
          <div class="summary-sub">
            <span>Yesterday: <strong id="returnsYday">0</strong></span>
            <span class="small-muted">Processing only</span>
          </div>
        </div>

        <div class="summary-card">
          <h4>Revenue (Fees)</h4>
          <div class="summary-main">
            <div class="summary-value" id="feesToday">$0</div>
            <div class="delta" id="feesDelta">—</div>
          </div>
          <div class="summary-sub">
            <span>Yesterday: <strong id="feesYday">$0</strong></span>
            <span class="small-muted">Fee Log</span>
          </div>
        </div>
      </div>

      <!-- RANGE + SNAPSHOT -->
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap;">
          <h3 style="margin:0;">Division snapshot</h3>
          <div class="badge"><span class="dot"></span><span id="rangeLabel">Today</span></div>
        </div>
        <div class="hr"></div>

        <div class="grid2">
          <div class="panel" style="box-shadow:none;border:1px solid var(--border);">
            <h3 style="font-size:15px;margin:0 0 10px;">CSR</h3>
            <div class="summary-sub" style="margin-top:0;">
              <span>Touchpoints: <strong id="csrTouchpoints">0</strong></span>
              <span>Outbound: <strong id="csrOutbound">0</strong></span>
            </div>
            <div class="summary-sub" style="margin-top:8px;">
              <span>Inbound: <strong id="csrInbound">0</strong></span>
              <span>Chat: <strong id="csrChat">0</strong></span>
            </div>
          </div>

          <div class="panel" style="box-shadow:none;border:1px solid var(--border);">
            <h3 style="font-size:15px;margin:0 0 10px;">Processing</h3>
            <div class="summary-sub" style="margin-top:0;">
              <span>Total output: <strong id="procOutput">0</strong></span>
              <span>Fees: <strong id="procFees">$0</strong></span>
            </div>
            <div class="summary-sub" style="margin-top:8px;">
              <span>Fee entries: <strong id="procFeeEntries">0</strong></span>
              <span class="small-muted">Selected fee types</span>
            </div>
          </div>
        </div>

        <div class="hr"></div>
        <div class="note">
          <strong>How to read:</strong> CSR touchpoints = inbound + outbound + chat. Processing total output = sum of output counters. Fees come from <strong>Fee_Log</strong> totals (filtered by fee type).
        </div>
      </div>

      <!-- RANKINGS -->
      <div class="grid2">
        <div class="panel">
          <h3>CSR staff ranking</h3>
          <div class="small-muted" style="margin-bottom:10px;">Sorted by touchpoints (inbound + outbound + chat)</div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Staff</th>
                  <th class="right">Touchpoints</th>
                  <th class="right">Inbound</th>
                  <th class="right">Outbound</th>
                  <th class="right">Chat</th>
                </tr>
              </thead>
              <tbody id="csrRankBody"></tbody>
            </table>
          </div>
        </div>

        <div class="panel">
          <h3>Processing staff ranking</h3>
          <div class="small-muted" style="margin-bottom:10px;">Sorted by fees (then total output)</div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Staff</th>
                  <th class="right">Fees</th>
                  <th class="right">Fee entries</th>
                  <th class="right">Total output</th>
                </tr>
              </thead>
              <tbody id="procRankBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- CSR GROUPED TABLES (no sideways scroll) -->
      <div class="panel">
        <h3>CSR breakdown (touchpoints)</h3>
        <div class="small-muted" style="margin-bottom:10px;">Inbound / Outbound / Chat / Emails</div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Staff</th>
                <th class="right">Inbound</th>
                <th class="right">Outbound</th>
                <th class="right">Chat</th>
                <th class="right">Emails</th>
                <th class="right">Touchpoints</th>
              </tr>
            </thead>
            <tbody id="csrTouchBody"></tbody>
          </table>
        </div>

        <div class="hr"></div>

        <h3 style="margin-top:0;">CSR breakdown (calling)</h3>
        <div class="small-muted" style="margin-bottom:10px;">INC/C Calling / Question Calling / A2A Calling</div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Staff</th>
                <th class="right">INC/C</th>
                <th class="right">Question</th>
                <th class="right">A2A Calling</th>
              </tr>
            </thead>
            <tbody id="csrCallingBody"></tbody>
          </table>
        </div>

        <div class="hr"></div>

        <h3 style="margin-top:0;">CSR breakdown (other)</h3>
        <div class="small-muted" style="margin-bottom:10px;">A2A / Unverified / Delinks / Cancellations</div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Staff</th>
                <th class="right">A2A</th>
                <th class="right">Unverified</th>
                <th class="right">Delinks</th>
                <th class="right">Cancels</th>
              </tr>
            </thead>
            <tbody id="csrOtherBody"></tbody>
          </table>
        </div>
      </div>

      <!-- PROCESSING GROUPED TABLES (no sideways scroll) -->
      <div class="panel">
        <h3>Processing breakdown (output)</h3>
        <div class="small-muted" style="margin-bottom:10px;">Total output + core counters</div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Staff</th>
                <th class="right">Total output</th>
                <th class="right">Filing</th>
                <th class="right">Linking</th>
                <th class="right">Linked Review</th>
                <th class="right">Inbox</th>
              </tr>
            </thead>
            <tbody id="procOutputBody"></tbody>
          </table>
        </div>

        <div class="hr"></div>

        <h3 style="margin-top:0;">Processing breakdown (reviews + misc)</h3>
        <div class="small-muted" style="margin-bottom:10px;">Existing / Processing Review / Misc</div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Staff</th>
                <th class="right">Existing Review</th>
                <th class="right">Processing Review</th>
                <th class="right">Misc</th>
              </tr>
            </thead>
            <tbody id="procReviewBody"></tbody>
          </table>
        </div>

        <div class="hr"></div>

        <h3 style="margin-top:0;">Processing fees (from Fee_Log)</h3>
        <div class="small-muted" style="margin-bottom:10px;">Fees are summed from Fee_Log for the date range and fee type filter</div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Staff</th>
                <th class="right">Fee entries</th>
                <th class="right">Total fees</th>
              </tr>
            </thead>
            <tbody id="procFeesBody"></tbody>
          </table>
        </div>
      </div>

      <!-- FEE BREAKDOWN -->
      <div class="panel">
        <h3>Fee breakdown by type</h3>
        <div class="small-muted" style="margin-bottom:10px;">Fee_Log totals in selected period (fixed type list always shown)</div>
        <div class="table-wrap">
          <table style="min-width:0;">
            <thead>
              <tr>
                <th>Fee type</th>
                <th class="right">Entries</th>
                <th class="right">Total fees</th>
              </tr>
            </thead>
            <tbody id="feeTypeBody"></tbody>
            <tfoot>
              <tr>
                <td><strong>Total</strong></td>
                <td class="right"><strong id="feeTypeTotalEntries">0</strong></td>
                <td class="right"><strong id="feeTypeTotalFees">$0</strong></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/* ===========================
   BACKEND
=========================== */
const WEB_APP_URL =
"https://script.google.com/macros/s/AKfycbwCZTuvnbwTAfkDXMjbLzCR-YXkzcbQ-hujbrZW7Hib5iLhbVwfkJ1xmSfpu-YfRGTn/exec";

/* ===========================
   NAV / CLOCK
=========================== */
function goHome(){ window.location.href="index.html"; }

(function tick(){
  document.getElementById("clock").textContent =
    new Date().toLocaleTimeString("en-NZ",{hour:"numeric",minute:"2-digit",second:"2-digit"});
  setTimeout(tick,1000);
})();

/* ===========================
   DATE DEFAULTS
=========================== */
const TZ = "Pacific/Auckland";
function nzISO(d=new Date()){
  return d.toLocaleDateString("en-CA",{timeZone:TZ});
}
function addDaysISO(iso,delta){
  const [y,m,dd]=iso.split("-").map(Number);
  const dt=new Date(Date.UTC(y,m-1,dd));
  dt.setUTCDate(dt.getUTCDate()+delta);
  return nzISO(new Date(dt));
}
const todayISO = nzISO();
document.getElementById("startDate").value = todayISO;
document.getElementById("endDate").value = todayISO;

/* ===========================
   MONEY + DELTAS
=========================== */
function money(n){
  const v = Number(n)||0;
  return "$" + v.toLocaleString("en-NZ",{minimumFractionDigits:2,maximumFractionDigits:2});
}
function pctChange(today, yday){
  const t = Number(today)||0;
  const y = Number(yday)||0;
  if(y===0 && t===0) return {text:"—", cls:""};
  if(y===0 && t>0) return {text:"+∞", cls:"up"};
  const p = ((t-y)/y)*100;
  const sign = p>0?"+":"";
  return {text:`${sign}${p.toFixed(0)}%`, cls: p>=0 ? "up" : "down"};
}
function formatDelta(el, today, yday){
  const p = pctChange(today, yday);
  el.classList.remove("up","down");
  if(p.cls) el.classList.add(p.cls);
  el.textContent = p.text;
}

/* ===========================
   SAFE DATE PARSING (sheet rows can be messy)
=========================== */
function toNZDayISO(value){
  if(value==null || value==="") return null;

  // If it already looks like YYYY-MM-DD, keep it.
  if(typeof value === "string" && /^\d{4}-\d{2}-\d{2}$/.test(value)) return value;

  // Try Date parse
  const d = new Date(value);
  if(isNaN(d.getTime())) return null;

  return d.toLocaleDateString("en-CA",{timeZone:TZ});
}
function inRange(nzDay, startISO, endISO){
  if(!nzDay) return false;
  return nzDay >= startISO && nzDay <= endISO;
}

/* ===========================
   FIXED FEE TYPES (always shown)
=========================== */
const FIXED_FEE_TYPES = ["ITA","IR3","REB","AA","R3P","OP","BY"];

/* ===========================
   FILTER STATE (checkbox-driven)
=========================== */
const state = {
  divisions: new Set(["CSR","Processing"]), // default both
  staffCSR: new Set(),        // empty means ALL
  staffProcessing: new Set(), // empty means ALL
  feeTypes: new Set()         // empty means ALL
};

function setStatus(text){
  document.getElementById("statusPill").textContent = text;
}

function buildCheckList(container, items, getChecked, setChecked){
  container.innerHTML = "";
  items.forEach(item=>{
    const row = document.createElement("label");
    row.className = "check";
    row.innerHTML = `<input type="checkbox"><strong></strong>`;
    row.querySelector("strong").textContent = item;

    const cb = row.querySelector("input");
    cb.checked = !!getChecked(item);

    row.addEventListener("click",(e)=>{
      // allow clicking anywhere
      if(e.target.tagName.toLowerCase() !== "input"){
        cb.checked = !cb.checked;
      }
      setChecked(item, cb.checked);
      updateFilterPills();
    });

    cb.addEventListener("change",()=>{
      setChecked(item, cb.checked);
      updateFilterPills();
    });

    container.appendChild(row);
  });
}

function updateFilterPills(){
  // Division pill
  const divCount = state.divisions.size;
  document.getElementById("divCount").textContent =
    divCount===0 ? "None" : (divCount===2 ? "2 selected" : "1 selected");

  // Staff pill (combined)
  const csrSel = state.staffCSR.size;
  const procSel = state.staffProcessing.size;
  const anySelected = (csrSel + procSel) > 0;
  document.getElementById("staffCountPill").textContent = anySelected ? "Filtered" : "All";

  // Fee pill
  document.getElementById("feeCountPill").textContent =
    state.feeTypes.size ? `${state.feeTypes.size} selected` : "All";
}

/* ===========================
   DATA CACHE
=========================== */
let CACHE = null;

async function fetchAllData(){
  const url = WEB_APP_URL + "?action=getReportData";
  const res = await fetch(url, { method:"GET" });
  const data = await res.json();
  if(!data || !data.ok) throw new Error((data && data.error) ? data.error : "Unknown error");
  return data;
}

/* ===========================
   NORMALISE ROWS
=========================== */
function normaliseCSRRow(r){
  const day = toNZDayISO(r.Date);
  return {
    day,
    staff: String(r.Staff||"").trim(),
    division: String(r.Division||"CSR").trim() || "CSR",
    inbound: Number(r.Inbound||0),
    outbound: Number(r.Outbound||0),
    chat: Number(r.Chat||0),
    emails: Number(r.Emails||0),
    a2a: Number(r.A2A||0),
    unverified: Number(r.Unverified||0),
    incc: Number(r.INC_C_Calling||0),
    qc: Number(r.Question_Calling||0),
    a2ac: Number(r.A2A_Calling||0),
    delinks: Number(r.Delinks||0),
    cancels: Number(r.Cancellations||0),
  };
}

function normaliseProcessingRow(r){
  const day = toNZDayISO(r.Date);
  return {
    day,
    staff: String(r.Staff||"").trim(),
    filing: Number(r.Filing||0),
    linking: Number(r.Linking||0),
    linkedReview: Number(r["Linked Review"]||r.LinkedReview||0),
    inbox: Number(r.Inbox||0),
    existingReview: Number(r["Existing Review"]||r.ExistingReview||0),
    processingReview: Number(r["Processing Review"]||r.ProcessingReview||0),
    misc: Number(r.Miscellaneous||0),
    totalOutput: Number(r["Total Output"]||r.TotalOutput||0),
    totalFees: Number(r["Total Fees"]||r.TotalFees||0), // kept for reference, but fees displayed come from Fee_Log
  };
}

function normaliseFeeRow(r){
  const day = toNZDayISO(r.Date);
  return {
    day,
    staff: String(r.Staff||"").trim(),
    type: String(r.Fee_Type||"").trim(),
    count: Number(r.Count||0),
    total: Number(r.Total_Fee||0)
  };
}

/* ===========================
   APPLY FILTERS
=========================== */
function getSelectedDivisions(){
  // empty means none (allowed, but results will be empty)
  return new Set(Array.from(state.divisions));
}
function staffAllowed(staff, division, allStaffByDivision){
  // if no specific staff selected for that division => all staff allowed
  if(division==="CSR"){
    if(state.staffCSR.size===0) return true;
    return state.staffCSR.has(staff);
  }
  if(division==="Processing"){
    if(state.staffProcessing.size===0) return true;
    return state.staffProcessing.has(staff);
  }
  return true;
}
function feeTypeAllowed(type){
  if(state.feeTypes.size===0) return true;
  return state.feeTypes.has(type);
}

/* ===========================
   RENDER HELPERS
=========================== */
function td(label, value, cls="right"){
  return `<td class="${cls}" data-label="${label}">${value}</td>`;
}
function nameTd(name){
  return `<td data-label="Staff"><strong>${escapeHtml(name)}</strong></td>`;
}
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ===========================
   REPORT
=========================== */
async function runReport(){
  setStatus("Loading…");

  const start = document.getElementById("startDate").value || todayISO;
  const end = document.getElementById("endDate").value || todayISO;

  // label
  const isToday = (start===todayISO && end===todayISO);
  document.getElementById("rangeLabel").textContent = isToday ? "Today (live)" : `${start} → ${end}`;

  try{
    if(!CACHE) CACHE = await fetchAllData();

    const allStaffByDivision = CACHE.allStaffByDivision || { CSR:[], Processing:[] };

    // Normalise and filter by date + division + staff
    const divisions = getSelectedDivisions();

    const csrRows = (CACHE.csr||[])
      .map(normaliseCSRRow)
      .filter(r => r.day && inRange(r.day, start, end))
      .filter(r => divisions.has("CSR"))
      .filter(r => staffAllowed(r.staff, "CSR", allStaffByDivision));

    const procRows = (CACHE.processing||[])
      .map(normaliseProcessingRow)
      .filter(r => r.day && inRange(r.day, start, end))
      .filter(r => divisions.has("Processing"))
      .filter(r => staffAllowed(r.staff, "Processing", allStaffByDivision));

    const feeRows = (CACHE.fees||[])
      .map(normaliseFeeRow)
      .filter(r => r.day && inRange(r.day, start, end))
      .filter(r => divisions.has("Processing")) // fees only for processing
      .filter(r => staffAllowed(r.staff, "Processing", allStaffByDivision))
      .filter(r => feeTypeAllowed(r.type));

    // yesterday comparisons only when single-day
    const singleDay = (start===end);
    const ydayISO = singleDay ? addDaysISO(start, -1) : null;

    const csrY = singleDay
      ? (CACHE.csr||[]).map(normaliseCSRRow).filter(r => r.day===ydayISO).filter(r=>divisions.has("CSR")).filter(r=>staffAllowed(r.staff,"CSR",allStaffByDivision))
      : [];

    const procY = singleDay
      ? (CACHE.processing||[]).map(normaliseProcessingRow).filter(r => r.day===ydayISO).filter(r=>divisions.has("Processing")).filter(r=>staffAllowed(r.staff,"Processing",allStaffByDivision))
      : [];

    const feeY = singleDay
      ? (CACHE.fees||[]).map(normaliseFeeRow).filter(r => r.day===ydayISO).filter(r=>divisions.has("Processing")).filter(r=>staffAllowed(r.staff,"Processing",allStaffByDivision)).filter(r=>feeTypeAllowed(r.type))
      : [];

    // Totals
    const csrInbound = csrRows.reduce((a,r)=>a+r.inbound,0);
    const csrOutbound = csrRows.reduce((a,r)=>a+r.outbound,0);
    const csrChat = csrRows.reduce((a,r)=>a+r.chat,0);
    const csrEmails = csrRows.reduce((a,r)=>a+r.emails,0);
    const csrTouchpoints = csrInbound + csrOutbound + csrChat;

    const csrTouchY = csrY.reduce((a,r)=>a+(r.inbound+r.outbound+r.chat),0);

    const procOutput = procRows.reduce((a,r)=>a+r.totalOutput,0);
    const procOutputY = procY.reduce((a,r)=>a+r.totalOutput,0);

    const feeEntries = feeRows.reduce((a,r)=>a+r.count,0);
    const feeTotal = Math.round(feeRows.reduce((a,r)=>a+r.total,0)*100)/100;

    const feeEntriesY = feeY.reduce((a,r)=>a+r.count,0);
    const feeTotalY = Math.round(feeY.reduce((a,r)=>a+r.total,0)*100)/100;

    // Top cards
    document.getElementById("touchpointsToday").textContent = csrTouchpoints.toLocaleString("en-NZ");
    document.getElementById("touchpointsYday").textContent = (singleDay ? csrTouchY : 0).toLocaleString("en-NZ");
    formatDelta(document.getElementById("touchpointsDelta"), csrTouchpoints, singleDay ? csrTouchY : 0);
    if(!singleDay){ document.getElementById("touchpointsDelta").textContent = "—"; document.getElementById("touchpointsYday").textContent="—"; }

    document.getElementById("returnsToday").textContent = procOutput.toLocaleString("en-NZ");
    document.getElementById("returnsYday").textContent = (singleDay ? procOutputY : 0).toLocaleString("en-NZ");
    formatDelta(document.getElementById("returnsDelta"), procOutput, singleDay ? procOutputY : 0);
    if(!singleDay){ document.getElementById("returnsDelta").textContent = "—"; document.getElementById("returnsYday").textContent="—"; }

    document.getElementById("feesToday").textContent = money(feeTotal);
    document.getElementById("feesYday").textContent = singleDay ? money(feeTotalY) : "—";
    formatDelta(document.getElementById("feesDelta"), feeTotal, singleDay ? feeTotalY : 0);
    if(!singleDay){ document.getElementById("feesDelta").textContent = "—"; }

    // Snapshot
    document.getElementById("csrTouchpoints").textContent = csrTouchpoints.toLocaleString("en-NZ");
    document.getElementById("csrInbound").textContent = csrInbound.toLocaleString("en-NZ");
    document.getElementById("csrOutbound").textContent = csrOutbound.toLocaleString("en-NZ");
    document.getElementById("csrChat").textContent = csrChat.toLocaleString("en-NZ");

    document.getElementById("procOutput").textContent = procOutput.toLocaleString("en-NZ");
    document.getElementById("procFees").textContent = money(feeTotal);
    document.getElementById("procFeeEntries").textContent = feeEntries.toLocaleString("en-NZ");

    // Group by staff helpers
    function groupByStaff(rows, getStaff){
      const map = {};
      rows.forEach(r=>{
        const s = getStaff(r);
        if(!s) return;
        if(!map[s]) map[s] = [];
        map[s].push(r);
      });
      return map;
    }

    // CSR per staff aggregation
    const csrByStaff = {};
    csrRows.forEach(r=>{
      if(!csrByStaff[r.staff]){
        csrByStaff[r.staff] = { inbound:0,outbound:0,chat:0,emails:0,a2a:0,unverified:0,incc:0,qc:0,a2ac:0,delinks:0,cancels:0 };
      }
      const o = csrByStaff[r.staff];
      o.inbound += r.inbound; o.outbound += r.outbound; o.chat += r.chat; o.emails += r.emails;
      o.a2a += r.a2a; o.unverified += r.unverified; o.incc += r.incc; o.qc += r.qc; o.a2ac += r.a2ac;
      o.delinks += r.delinks; o.cancels += r.cancels;
    });

    // Processing per staff aggregation
    const procByStaff = {};
    procRows.forEach(r=>{
      if(!procByStaff[r.staff]){
        procByStaff[r.staff] = { filing:0,linking:0,linkedReview:0,inbox:0,existingReview:0,processingReview:0,misc:0,totalOutput:0 };
      }
      const o = procByStaff[r.staff];
      o.filing += r.filing; o.linking += r.linking; o.linkedReview += r.linkedReview; o.inbox += r.inbox;
      o.existingReview += r.existingReview; o.processingReview += r.processingReview; o.misc += r.misc;
      o.totalOutput += r.totalOutput;
    });

    // Fees per staff aggregation (Fee_Log)
    const feeByStaff = {};
    feeRows.forEach(r=>{
      if(!feeByStaff[r.staff]) feeByStaff[r.staff] = { entries:0, total:0 };
      feeByStaff[r.staff].entries += r.count;
      feeByStaff[r.staff].total += r.total;
    });
    Object.keys(feeByStaff).forEach(s=>{
      feeByStaff[s].total = Math.round(feeByStaff[s].total * 100) / 100;
    });

    // CSR ranking (touchpoints)
    const csrRank = Object.keys(csrByStaff).map(name=>{
      const o = csrByStaff[name];
      const tp = o.inbound + o.outbound + o.chat;
      return { name, tp, inbound:o.inbound, outbound:o.outbound, chat:o.chat };
    }).sort((a,b)=>b.tp-a.tp);

    document.getElementById("csrRankBody").innerHTML =
      csrRank.length ? csrRank.map((r,i)=>`
        <tr>
          <td data-label="Rank">${i+1}</td>
          ${nameTd(r.name)}
          ${td("Touchpoints", `<strong>${r.tp.toLocaleString("en-NZ")}</strong>`)}
          ${td("Inbound", r.inbound.toLocaleString("en-NZ"))}
          ${td("Outbound", r.outbound.toLocaleString("en-NZ"))}
          ${td("Chat", r.chat.toLocaleString("en-NZ"))}
        </tr>
      `).join("") : `<tr><td colspan="6" class="small-muted">No CSR data for current filters.</td></tr>`;

    // Processing ranking (fees then output)
    const procRank = Object.keys(procByStaff).map(name=>{
      const out = procByStaff[name].totalOutput || 0;
      const fees = (feeByStaff[name] ? feeByStaff[name].total : 0);
      const entries = (feeByStaff[name] ? feeByStaff[name].entries : 0);
      return { name, fees, entries, out };
    }).sort((a,b)=>{
      if(b.fees!==a.fees) return b.fees-a.fees;
      return b.out-a.out;
    });

    document.getElementById("procRankBody").innerHTML =
      procRank.length ? procRank.map((r,i)=>`
        <tr>
          <td data-label="Rank">${i+1}</td>
          ${nameTd(r.name)}
          ${td("Fees", `<strong>${money(r.fees)}</strong>`)}
          ${td("Fee entries", r.entries.toLocaleString("en-NZ"))}
          ${td("Total output", r.out.toLocaleString("en-NZ"))}
        </tr>
      `).join("") : `<tr><td colspan="5" class="small-muted">No Processing data for current filters.</td></tr>`;

    // CSR grouped tables
    const csrNames = Object.keys(csrByStaff).sort((a,b)=>a.localeCompare(b));
    document.getElementById("csrTouchBody").innerHTML =
      csrNames.length ? csrNames.map(name=>{
        const o = csrByStaff[name];
        const tp = o.inbound + o.outbound + o.chat;
        return `
          <tr>
            ${nameTd(name)}
            ${td("Inbound", o.inbound.toLocaleString("en-NZ"))}
            ${td("Outbound", o.outbound.toLocaleString("en-NZ"))}
            ${td("Chat", o.chat.toLocaleString("en-NZ"))}
            ${td("Emails", o.emails.toLocaleString("en-NZ"))}
            ${td("Touchpoints", `<strong>${tp.toLocaleString("en-NZ")}</strong>`)}
          </tr>
        `;
      }).join("") : `<tr><td colspan="6" class="small-muted">No CSR data for current filters.</td></tr>`;

    document.getElementById("csrCallingBody").innerHTML =
      csrNames.length ? csrNames.map(name=>{
        const o = csrByStaff[name];
        return `
          <tr>
            ${nameTd(name)}
            ${td("INC/C", o.incc.toLocaleString("en-NZ"))}
            ${td("Question", o.qc.toLocaleString("en-NZ"))}
            ${td("A2A Calling", o.a2ac.toLocaleString("en-NZ"))}
          </tr>
        `;
      }).join("") : `<tr><td colspan="4" class="small-muted">No CSR data for current filters.</td></tr>`;

    document.getElementById("csrOtherBody").innerHTML =
      csrNames.length ? csrNames.map(name=>{
        const o = csrByStaff[name];
        return `
          <tr>
            ${nameTd(name)}
            ${td("A2A", o.a2a.toLocaleString("en-NZ"))}
            ${td("Unverified", o.unverified.toLocaleString("en-NZ"))}
            ${td("Delinks", o.delinks.toLocaleString("en-NZ"))}
            ${td("Cancels", o.cancels.toLocaleString("en-NZ"))}
          </tr>
        `;
      }).join("") : `<tr><td colspan="5" class="small-muted">No CSR data for current filters.</td></tr>`;

    // Processing grouped tables
    const procNames = Object.keys(procByStaff).sort((a,b)=>a.localeCompare(b));

    document.getElementById("procOutputBody").innerHTML =
      procNames.length ? procNames.map(name=>{
        const o = procByStaff[name];
        return `
          <tr>
            ${nameTd(name)}
            ${td("Total output", `<strong>${o.totalOutput.toLocaleString("en-NZ")}</strong>`)}
            ${td("Filing", o.filing.toLocaleString("en-NZ"))}
            ${td("Linking", o.linking.toLocaleString("en-NZ"))}
            ${td("Linked Review", o.linkedReview.toLocaleString("en-NZ"))}
            ${td("Inbox", o.inbox.toLocaleString("en-NZ"))}
          </tr>
        `;
      }).join("") : `<tr><td colspan="6" class="small-muted">No Processing data for current filters.</td></tr>`;

    document.getElementById("procReviewBody").innerHTML =
      procNames.length ? procNames.map(name=>{
        const o = procByStaff[name];
        return `
          <tr>
            ${nameTd(name)}
            ${td("Existing Review", o.existingReview.toLocaleString("en-NZ"))}
            ${td("Processing Review", o.processingReview.toLocaleString("en-NZ"))}
            ${td("Misc", o.misc.toLocaleString("en-NZ"))}
          </tr>
        `;
      }).join("") : `<tr><td colspan="4" class="small-muted">No Processing data for current filters.</td></tr>`;

    document.getElementById("procFeesBody").innerHTML =
      procNames.length ? procNames.map(name=>{
        const f = feeByStaff[name] || { entries:0, total:0 };
        return `
          <tr>
            ${nameTd(name)}
            ${td("Fee entries", f.entries.toLocaleString("en-NZ"))}
            ${td("Total fees", `<strong>${money(f.total)}</strong>`)}
          </tr>
        `;
      }).join("") : `<tr><td colspan="3" class="small-muted">No Processing data for current filters.</td></tr>`;

    // Fee breakdown by type (fixed list always shown)
    const feeTotalsByType = {};
    FIXED_FEE_TYPES.forEach(t=>feeTotalsByType[t]={entries:0,total:0});

    feeRows.forEach(r=>{
      if(!feeTotalsByType[r.type]){
        // if a future type arrives, include it too (but do not remove fixed list)
        feeTotalsByType[r.type] = { entries:0,total:0 };
      }
      feeTotalsByType[r.type].entries += r.count;
      feeTotalsByType[r.type].total += r.total;
    });

    const orderedTypes = [
      ...FIXED_FEE_TYPES,
      ...Object.keys(feeTotalsByType).filter(t=>!FIXED_FEE_TYPES.includes(t)).sort((a,b)=>a.localeCompare(b))
    ];

    let totalEntries = 0, totalFeesAll = 0;
    const feeRowsHtml = orderedTypes.map(t=>{
      const v = feeTotalsByType[t] || { entries:0,total:0 };
      const total = Math.round((v.total||0)*100)/100;
      totalEntries += (v.entries||0);
      totalFeesAll += total;
      return `
        <tr>
          <td data-label="Fee type"><strong>${escapeHtml(t)}</strong></td>
          ${td("Entries", (v.entries||0).toLocaleString("en-NZ"))}
          ${td("Total fees", money(total))}
        </tr>
      `;
    }).join("");

    document.getElementById("feeTypeBody").innerHTML = feeRowsHtml || `<tr><td colspan="3" class="small-muted">No fee data for current filters.</td></tr>`;
    document.getElementById("feeTypeTotalEntries").textContent = totalEntries.toLocaleString("en-NZ");
    document.getElementById("feeTypeTotalFees").textContent = money(Math.round(totalFeesAll*100)/100);

    setStatus(isToday ? "Live Today" : "Filtered period");

  }catch(err){
    console.error(err);
    setStatus("Connection error");
    alert("Connection error");
  }
}

/* ===========================
   PDF (placeholder)
=========================== */
function downloadPDF(){
  alert("PDF will match current filters (next phase).");
}

/* ===========================
   INIT FILTER UI (from backend staff lists)
=========================== */
async function init(){
  setStatus("Loading…");
  try{
    CACHE = await fetchAllData();

    // Division checks (fixed)
    buildCheckList(
      document.getElementById("divisionChecks"),
      ["CSR","Processing"],
      (d)=>state.divisions.has(d),
      (d,checked)=>{
        if(checked) state.divisions.add(d);
        else state.divisions.delete(d);
      }
    );

    // Staff checks (from backend allStaffByDivision)
    const staffCSR = (CACHE.allStaffByDivision && CACHE.allStaffByDivision.CSR) ? CACHE.allStaffByDivision.CSR : [];
    const staffProc = (CACHE.allStaffByDivision && CACHE.allStaffByDivision.Processing) ? CACHE.allStaffByDivision.Processing : [];

    buildCheckList(
      document.getElementById("staffChecksCSR"),
      staffCSR.slice().sort((a,b)=>String(a).localeCompare(String(b))),
      (name)=>state.staffCSR.has(name),
      (name,checked)=>{
        if(checked) state.staffCSR.add(name);
        else state.staffCSR.delete(name);
      }
    );

    buildCheckList(
      document.getElementById("staffChecksProcessing"),
      staffProc.slice().sort((a,b)=>String(a).localeCompare(String(b))),
      (name)=>state.staffProcessing.has(name),
      (name,checked)=>{
        if(checked) state.staffProcessing.add(name);
        else state.staffProcessing.delete(name);
      }
    );

    // Fee type checks (fixed list always)
    buildCheckList(
      document.getElementById("feeChecks"),
      FIXED_FEE_TYPES,
      (t)=>state.feeTypes.has(t),
      (t,checked)=>{
        if(checked) state.feeTypes.add(t);
        else state.feeTypes.delete(t);
      }
    );

    updateFilterPills();
    setStatus("Ready");
    runReport();
  }catch(err){
    console.error(err);
    setStatus("Connection error");
    alert("Connection error");
  }
}

init();
</script>

</body>
</html>
