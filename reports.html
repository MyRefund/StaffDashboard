<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="Content-Language" content="en">
<meta name="google" content="notranslate">

<title>My Refund — Reports</title>

<style>
:root{
  --g0:#094B35;
  --g2:#ECFDF5;
  --border:#e5e7eb;
  --text:#111827;
  --muted:#6b7280;
  --radius:16px;
  --shadow:0 12px 32px rgba(0,0,0,.12);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Okta Neue", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background:#f9fafb;
  color:var(--text);
}

/* HEADER */
.header{
  background:var(--g0);
  color:#fff;
  padding:14px 24px;
}
.header-inner{
  max-width:1400px;
  margin:0 auto;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.brand{
  display:flex;
  gap:14px;
  align-items:center;
}
.brand img{height:26px}
.brand-text{display:flex;flex-direction:column;line-height:1.1}
.brand-text strong{font-weight:900;font-size:15px}
.brand-text span{font-size:12px;opacity:.9;font-weight:700}
.header-right{
  display:flex;
  align-items:center;
  gap:14px;
}
.dashboard-btn{
  border-radius:999px;
  padding:8px 16px;
  font-weight:900;
  font-size:13px;
  border:1px solid #fff;
  background:transparent;
  color:#fff;
  cursor:pointer;
}
.clock{font-weight:900;font-size:14px}

/* TOP FILTER BAR (kept, but we’ll keep it minimal; sidebar is primary) */
.topbar{
  max-width:1400px;
  margin:20px auto 0;
  padding:16px;
  background:#fff;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  display:flex;
  flex-wrap:wrap;
  gap:14px;
  align-items:flex-end;
}

.field{
  display:flex;
  flex-direction:column;
  font-size:12px;
  font-weight:900;
  min-width:160px;
}
.field input{
  margin-top:6px;
  padding:8px 10px;
  border-radius:10px;
  border:1px solid var(--border);
  font-weight:800;
  background:#fff;
}
button.primary{
  padding:10px 18px;
  border-radius:12px;
  background:var(--g0);
  color:#fff;
  border:none;
  font-weight:900;
  cursor:pointer;
}
button.secondary{
  padding:10px 18px;
  border-radius:12px;
  background:#fff;
  border:1px solid var(--g0);
  color:var(--g0);
  font-weight:900;
  cursor:pointer;
}

.status-pill{
  padding:8px 12px;
  border-radius:999px;
  background:var(--g2);
  font-size:12px;
  font-weight:900;
  color:var(--g0);
  border:1px solid rgba(9,75,53,.12);
}

/* Multi-select dropdown (checkbox style) */
.mselect{
  position:relative;
  margin-top:6px;
}
.mselect-btn{
  width:100%;
  text-align:left;
  padding:9px 10px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#fff;
  font-weight:900;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:center;
}
.mselect-btn span{
  font-weight:800;
  color:var(--text);
  font-size:13px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.chev{opacity:.7;font-weight:900}
.mselect-panel{
  position:absolute;
  left:0; right:0;
  top:calc(100% + 8px);
  z-index:50;
  background:#fff;
  border:1px solid var(--border);
  border-radius:14px;
  box-shadow:var(--shadow);
  padding:10px;
  display:none;
}
.mselect.open .mselect-panel{display:block}
.mselect-search{
  width:100%;
  padding:8px 10px;
  border-radius:10px;
  border:1px solid var(--border);
  font-weight:800;
  margin-bottom:10px;
}
.mselect-list{
  max-height:240px;
  overflow:auto;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.mopt{
  display:flex;
  align-items:center;
  gap:10px;
  padding:8px 10px;
  border-radius:10px;
  cursor:pointer;
}
.mopt:hover{background:#f3f4f6}
.mopt input{transform:scale(1.05)}
.mopt strong{font-size:13px}
.mselect-actions{
  display:flex;
  gap:10px;
  justify-content:space-between;
  margin-top:10px;
}
.smallbtn{
  border:1px solid var(--border);
  background:#fff;
  border-radius:10px;
  padding:8px 10px;
  font-weight:900;
  cursor:pointer;
  font-size:12px;
}
.smallbtn.primary{
  border-color:var(--g0);
  color:var(--g0);
}

/* ===== NEW: TWO-COLUMN LAYOUT (SIDEBAR + MAIN) ===== */
.shell{
  max-width:1400px;
  margin:20px auto 60px;
  padding:0 16px;
  display:grid;
  grid-template-columns:320px 1fr;
  gap:16px;
}
@media(max-width:1100px){
  .shell{grid-template-columns:1fr}
}
.sidebar{
  background:#fff;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:16px;
  position:sticky;
  top:16px;
  align-self:start;
}
@media(max-width:1100px){
  .sidebar{position:static}
}
.sidebar h3{
  margin:0 0 10px;
  font-weight:900;
  color:var(--g0);
  font-size:16px;
}
.sidebar .hint{
  font-size:12px;
  font-weight:800;
  color:var(--muted);
  line-height:1.4;
  margin-bottom:12px;
}
.sidebar .group{
  margin-bottom:12px;
}
.sidebar .group .label{
  font-size:12px;
  font-weight:900;
  margin-bottom:6px;
}
.sidebar .divider{
  height:1px;
  background:var(--border);
  margin:12px 0;
}
.sidebar .btnrow{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

/* CONTENT (MAIN) */
.content{
  display:flex;
  flex-direction:column;
  gap:18px;
}

/* SUMMARY */
.summary-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:16px;
}
.summary-card{
  background:#fff;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:18px 18px 16px;
}
.summary-card h4{
  margin:0;
  font-size:13px;
  font-weight:900;
  color:var(--muted);
}
.summary-main{
  margin-top:10px;
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:10px;
}
.summary-value{
  font-size:28px;
  font-weight:900;
  color:var(--g0);
  line-height:1;
}
.delta{
  font-size:12px;
  font-weight:900;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#fff;
  white-space:nowrap;
}
.delta.up{color:#065f46;background:#ecfdf5;border-color:rgba(6,95,70,.18)}
.delta.down{color:#7c2d12;background:#fff7ed;border-color:rgba(124,45,18,.18)}
.summary-sub{
  margin-top:10px;
  display:flex;
  justify-content:space-between;
  color:var(--muted);
  font-weight:900;
  font-size:12px;
}
.summary-sub strong{color:var(--g0)}

/* PANELS */
.panel{
  background:#fff;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:18px;
}
.panel h3{
  margin:0 0 12px;
  font-weight:900;
  color:var(--g0);
  font-size:16px;
}
.grid2{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
}
@media(max-width:980px){
  .grid2{grid-template-columns:1fr}
}

.table-wrap{overflow:auto}
table{
  width:100%;
  border-collapse:collapse;
  min-width:720px;
}
th,td{
  padding:10px 8px;
  border-bottom:1px solid var(--border);
  font-size:13px;
}
th{
  text-align:left;
  color:var(--muted);
  font-weight:900;
}
td strong{color:var(--g0)}
.right{text-align:right}
.small-muted{color:var(--muted);font-weight:800;font-size:12px}
.badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  font-size:12px;
  font-weight:900;
  color:var(--g0);
  background:var(--g2);
}
.dot{
  width:8px;height:8px;border-radius:50%;
  background:#16a34a;
}
.dot.warn{background:#f59e0b}
.dot.bad{background:#dc2626}

/* Divider line inside panels */
.hr{
  height:1px;background:var(--border);margin:14px 0;
}

/* Footer note */
.note{
  font-size:12px;
  font-weight:800;
  color:var(--muted);
  line-height:1.5;
}
.note strong{color:var(--g0)}
</style>
</head>

<body>

<div class="header">
  <div class="header-inner">
    <div class="brand">
      <img src="logo.png" alt="My Refund">
      <div class="brand-text">
        <strong>Reports</strong>
        <span>Live overview + filters</span>
      </div>
    </div>

    <div class="header-right">
      <button class="dashboard-btn" onclick="goHome()">← Dashboard</button>
      <div class="clock" id="clock"></div>
    </div>
  </div>
</div>

<!-- TOP FILTER BAR (kept, not removed) -->
<div class="topbar">
  <div class="field">
    Date From
    <input type="date" id="startDate">
  </div>

  <div class="field">
    Date To
    <input type="date" id="endDate">
  </div>

  <button class="primary" id="runBtn" onclick="runReport()">Run Report</button>
  <button class="secondary" onclick="downloadPDF()">Download PDF</button>

  <div class="status-pill" id="statusPill">Live Today</div>
</div>

<!-- NEW SHELL: SIDEBAR + MAIN CONTENT -->
<div class="shell">

  <!-- SIDEBAR FILTERS -->
  <aside class="sidebar">
    <h3>Filters</h3>
    <div class="hint">Select as many filters as you want. Empty = “All”. Filters apply across all panels and tables.</div>

    <div class="group">
      <div class="label">Division</div>
      <div class="mselect" data-ms="division"></div>
    </div>

    <div class="group">
      <div class="label">Staff</div>
      <div class="mselect" data-ms="staff"></div>
    </div>

    <div class="group">
      <div class="label">Work Type</div>
      <div class="mselect" data-ms="work"></div>
    </div>

    <div class="group">
      <div class="label">Fee Type</div>
      <div class="mselect" data-ms="fee"></div>
    </div>

    <div class="divider"></div>

    <div class="btnrow">
      <button class="primary" type="button" onclick="runReport()">Run Report</button>
      <button class="secondary" type="button" onclick="resetFilters()">Reset</button>
    </div>

    <div class="divider"></div>
    <div class="note">
      <strong>Note:</strong> Revenue is calculated from <strong>Fee_Log</strong> only.
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="content">

    <!-- EXEC SNAPSHOT -->
    <div class="summary-grid">
      <div class="summary-card">
        <h4>Client Touchpoints</h4>
        <div class="summary-main">
          <div class="summary-value" id="touchpointsToday">0</div>
          <div class="delta" id="touchpointsDelta">—</div>
        </div>
        <div class="summary-sub">
          <span>Yesterday: <strong id="touchpointsYday">0</strong></span>
          <span class="small-muted">CSR only</span>
        </div>
      </div>

      <div class="summary-card">
        <h4>Returns Processed</h4>
        <div class="summary-main">
          <div class="summary-value" id="returnsToday">0</div>
          <div class="delta" id="returnsDelta">—</div>
        </div>
        <div class="summary-sub">
          <span>Yesterday: <strong id="returnsYday">0</strong></span>
          <span class="small-muted">Processing only</span>
        </div>
      </div>

      <div class="summary-card">
        <h4>Revenue (Fees)</h4>
        <div class="summary-main">
          <div class="summary-value" id="feesToday">$0</div>
          <div class="delta" id="feesDelta">—</div>
        </div>
        <div class="summary-sub">
          <span>Yesterday: <strong id="feesYday">$0</strong></span>
          <span class="small-muted">From Fee_Log</span>
        </div>
      </div>

      <div class="summary-card">
        <h4>Active Staff Logged</h4>
        <div class="summary-main">
          <div class="summary-value" id="activeStaffToday">0</div>
          <div class="delta" id="activeDelta">—</div>
        </div>
        <div class="summary-sub">
          <span>Yesterday: <strong id="activeStaffYday">0</strong></span>
          <span class="small-muted">All</span>
        </div>
      </div>
    </div>

    <!-- DIVISION SNAPSHOT -->
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap;">
        <h3 style="margin:0;">Division snapshot</h3>
        <div class="badge"><span class="dot"></span><span id="rangeLabel">Today</span></div>
      </div>
      <div class="hr"></div>

      <div class="grid2">
        <div class="panel" style="box-shadow:none;border:1px solid var(--border);">
          <h3 style="font-size:15px;margin:0 0 10px;">CSR</h3>
          <div class="summary-sub" style="margin-top:0;">
            <span>Touchpoints: <strong id="csrTouchpoints">0</strong></span>
            <span>Outbound: <strong id="csrOutbound">0</strong></span>
          </div>
          <div class="summary-sub" style="margin-top:8px;">
            <span>Inbound: <strong id="csrInbound">0</strong></span>
            <span>Chat: <strong id="csrChat">0</strong></span>
          </div>
        </div>

        <div class="panel" style="box-shadow:none;border:1px solid var(--border);">
          <h3 style="font-size:15px;margin:0 0 10px;">Processing</h3>
          <div class="summary-sub" style="margin-top:0;">
            <span>Total output: <strong id="procOutput">0</strong></span>
            <span>Fees: <strong id="procFees">$0</strong></span>
          </div>
          <div class="summary-sub" style="margin-top:8px;">
            <span>Fee entries: <strong id="procFeeEntries">0</strong></span>
            <span class="small-muted">From Fee_Log</span>
          </div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="note">
        <strong>How to read:</strong> CSR touchpoints = inbound + outbound + chat. Processing total output = sum of all output counters. Fees + fee entries come from Fee_Log.
      </div>
    </div>

    <!-- STAFF RANKINGS -->
    <div class="grid2">
      <div class="panel">
        <h3>CSR staff ranking</h3>
        <div class="small-muted" style="margin-bottom:10px;">Sorted by total touchpoints (inbound + outbound + chat)</div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Rank</th>
                <th>Staff</th>
                <th class="right">Touchpoints</th>
                <th class="right">Inbound</th>
                <th class="right">Outbound</th>
                <th class="right">Chat</th>
                <th class="right">Emails</th>
              </tr>
            </thead>
            <tbody id="csrRankBody"></tbody>
          </table>
        </div>
      </div>

      <div class="panel">
        <h3>Processing staff ranking</h3>
        <div class="small-muted" style="margin-bottom:10px;">Sorted by total fees (then output)</div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Rank</th>
                <th>Staff</th>
                <th class="right">Fees</th>
                <th class="right">Fee entries</th>
                <th class="right">Total output</th>
              </tr>
            </thead>
            <tbody id="procRankBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- FULL DETAIL TABLES -->
    <div class="panel">
      <h3>CSR full breakdown</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Staff</th>
              <th class="right">Inbound</th>
              <th class="right">Outbound</th>
              <th class="right">Chat</th>
              <th class="right">Emails</th>
              <th class="right">A2A</th>
              <th class="right">Unverified</th>
              <th class="right">INC/C</th>
              <th class="right">Question</th>
              <th class="right">A2A Calling</th>
              <th class="right">Delinks</th>
              <th class="right">Cancels</th>
            </tr>
          </thead>
          <tbody id="csrFullBody"></tbody>
        </table>
      </div>
    </div>

    <div class="panel">
      <h3>Processing full breakdown</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Staff</th>
              <th class="right">Filing</th>
              <th class="right">Linking</th>
              <th class="right">Linked Review</th>
              <th class="right">Inbox</th>
              <th class="right">Existing Review</th>
              <th class="right">Processing Review</th>
              <th class="right">Misc</th>
              <th class="right">Total output</th>
              <th class="right">Fees</th>
              <th class="right">Fee entries</th>
            </tr>
          </thead>
          <tbody id="procFullBody"></tbody>
        </table>
      </div>
    </div>

    <div class="panel">
      <h3>Fee breakdown by type</h3>
      <div class="small-muted" style="margin-bottom:10px;">Includes only fee entries in the selected period + filters</div>
      <div class="table-wrap">
        <table style="min-width:520px;">
          <thead>
            <tr>
              <th>Fee type</th>
              <th class="right">Entries</th>
              <th class="right">Total fees</th>
            </tr>
          </thead>
          <tbody id="feeTypeBody"></tbody>
          <tfoot>
            <tr>
              <td><strong>Total</strong></td>
              <td class="right"><strong id="feeTypeTotalEntries">0</strong></td>
              <td class="right"><strong id="feeTypeTotalFees">$0</strong></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

  </main>
</div>

<script>
/* ===========================
   BACKEND URL
=========================== */
const WEB_APP_URL =
  "https://script.google.com/macros/s/AKfycbwCZTuvnbwTAfkDXMjbLzCR-YXkzcbQ-hujbrZW7Hib5iLhbVwfkJ1xmSfpu-YfRGTn/exec";

/* ===========================
   NAV / CLOCK
=========================== */
function goHome(){ window.location.href="index.html"; }

(function tick(){
  document.getElementById("clock").textContent =
    new Date().toLocaleTimeString("en-NZ",{hour:"numeric",minute:"2-digit",second:"2-digit"});
  setTimeout(tick,1000);
})();

/* ===========================
   DATE DEFAULTS
=========================== */
const TZ = "Pacific/Auckland";
function nzISO(d=new Date()){
  return d.toLocaleDateString("en-CA",{timeZone:TZ});
}
function addDaysISO(iso,delta){
  const [y,m,dd]=iso.split("-").map(Number);
  const dt=new Date(Date.UTC(y,m-1,dd));
  dt.setUTCDate(dt.getUTCDate()+delta);
  return nzISO(new Date(dt));
}
const todayISO = nzISO();
document.getElementById("startDate").value = todayISO;
document.getElementById("endDate").value = todayISO;

/* ===========================
   HELPERS
=========================== */
function money(n){
  const v = Number(n)||0;
  return "$" + v.toLocaleString("en-NZ",{minimumFractionDigits:2,maximumFractionDigits:2});
}
function pctChange(today, yday){
  const t = Number(today)||0;
  const y = Number(yday)||0;
  if(y===0 && t===0) return {text:"—", cls:""};
  if(y===0 && t>0) return {text:"+∞", cls:"up"};
  const p = ((t-y)/y)*100;
  const sign = p>0?"+":"";
  return {text:`${sign}${p.toFixed(0)}%`, cls: p>=0 ? "up" : "down"};
}
function formatDelta(el, today, yday){
  const p = pctChange(today, yday);
  el.classList.remove("up","down");
  if(p.cls) el.classList.add(p.cls);
  el.textContent = p.text;
}

function setStatus(text){
  document.getElementById("statusPill").textContent = text;
}

/* Normalize sheet dates into ISO yyyy-mm-dd if possible */
function normISO(v){
  if(!v && v!==0) return "";
  if (typeof v === "string"){
    // If already yyyy-mm-dd
    if (/^\d{4}-\d{2}-\d{2}$/.test(v.trim())) return v.trim();
    // Try parse
    const d = new Date(v);
    if (!isNaN(d.getTime())) return nzISO(d);
    return v.trim();
  }
  if (v instanceof Date) return nzISO(v);
  // Google sheets may return Date object but sometimes number
  if (typeof v === "number"){
    const d = new Date(Math.round((v - 25569) * 86400 * 1000)); // Excel-ish serial fallback
    if (!isNaN(d.getTime())) return nzISO(d);
  }
  return String(v);
}

function betweenISO(iso, start, end){
  if(!iso) return false;
  return (iso >= start && iso <= end);
}

/* ===========================
   MULTISELECT STATE
=========================== */
const msState = {
  division: new Set(["CSR","Processing"]),
  staff: new Set(),
  work: new Set(),
  fee: new Set()
};

/* Canonical work + fee lists (matches your UI naming) */
const CSR_WORK = ["Inbound","Outbound","Chat","Emails","A2A","Unverified","INC/C Calling","Question Calling","A2A Calling","Delinks","Cancellations"];
const PROC_WORK = ["Filing","Linking","Linked Review","Inbox","Existing Review","Processing Review","Miscellaneous"];

/* ===========================
   MULTISELECT COMPONENT
=========================== */
function buildMultiSelect(el, key, options){
  el.classList.add("mselect");
  el.innerHTML = `
    <button type="button" class="mselect-btn" aria-haspopup="listbox">
      <span id="ms_label_${key}">All</span>
      <span class="chev">▼</span>
    </button>
    <div class="mselect-panel">
      <input class="mselect-search" placeholder="Search…" />
      <div class="mselect-list" role="listbox"></div>
      <div class="mselect-actions">
        <button type="button" class="smallbtn" data-act="clear">Clear</button>
        <button type="button" class="smallbtn" data-act="all">Select all</button>
        <button type="button" class="smallbtn primary" data-act="apply">Apply</button>
      </div>
    </div>
  `;

  const btn = el.querySelector(".mselect-btn");
  const list = el.querySelector(".mselect-list");
  const search = el.querySelector(".mselect-search");
  const label = el.querySelector(`#ms_label_${key}`);
  const selected = msState[key];

  function renderList(filter=""){
    const f = filter.trim().toLowerCase();
    list.innerHTML = "";
    options
      .filter(o => !f || o.toLowerCase().includes(f))
      .forEach(o=>{
        const row=document.createElement("div");
        row.className="mopt";
        row.innerHTML = `
          <input type="checkbox" ${selected.has(o) ? "checked":""}>
          <strong>${o}</strong>
        `;
        row.onclick = (e)=>{
          if(e.target.tagName.toLowerCase() !== "input"){
            const cb = row.querySelector("input");
            cb.checked = !cb.checked;
          }
          const cb = row.querySelector("input");
          if(cb.checked) selected.add(o); else selected.delete(o);
        };
        row.querySelector("input").onchange = ()=>{
          const cb = row.querySelector("input");
          if(cb.checked) selected.add(o); else selected.delete(o);
        };
        list.appendChild(row);
      });
  }

  function updateLabel(){
    if(selected.size===0) { label.textContent = "All"; return; }
    if(selected.size===options.length) { label.textContent = "All"; return; }
    const arr = Array.from(selected);
    label.textContent = arr.length===1 ? arr[0] : `${arr.length} selected`;
  }

  btn.onclick = ()=>{
    document.querySelectorAll(".mselect.open").forEach(x=>{
      if(x!==el) x.classList.remove("open");
    });
    el.classList.toggle("open");
    search.value="";
    renderList("");
    updateLabel();
    if(el.classList.contains("open")) setTimeout(()=>search.focus(),0);
  };

  search.oninput = ()=>renderList(search.value);

  el.querySelector('[data-act="clear"]').onclick = (e)=>{
    e.preventDefault();
    selected.clear();
    renderList(search.value);
  };
  el.querySelector('[data-act="all"]').onclick = (e)=>{
    e.preventDefault();
    options.forEach(o=>selected.add(o));
    renderList(search.value);
  };
  el.querySelector('[data-act="apply"]').onclick = (e)=>{
    e.preventDefault();
    el.classList.remove("open");
    updateLabel();
    runReport();
  };

  document.addEventListener("click",(ev)=>{
    if(!el.contains(ev.target)) el.classList.remove("open");
  });

  updateLabel();
}

/* ===========================
   FILTER OPTIONS (DYNAMIC FROM DATA)
=========================== */
let ALL_CSR = [];
let ALL_PROC = [];
let ALL_FEES = [];
let FEE_TYPES = ["ITA","IR3","REB","AA","R3P","OP"]; // fallback

function getFilterSet(key, options){
  const s = msState[key];
  if(!s || s.size===0) return new Set(options);
  if(s.size===options.length) return new Set(options);
  return new Set(Array.from(s));
}

function selectedDivisions(){
  return getFilterSet("division", ["CSR","Processing"]);
}

function refreshStaffOptionsFromData(){
  const divs = selectedDivisions();
  const names = new Set();
  if(divs.has("CSR")){
    ALL_CSR.forEach(r=>{ if(r.Staff) names.add(String(r.Staff)); });
  }
  if(divs.has("Processing")){
    ALL_PROC.forEach(r=>{ if(r.Staff) names.add(String(r.Staff)); });
  }
  return Array.from(names).sort((a,b)=>a.localeCompare(b));
}

function refreshWorkOptions(){
  const divs = selectedDivisions();
  const work = [];
  if(divs.has("CSR")) CSR_WORK.forEach(w=>{ if(!work.includes(w)) work.push(w); });
  if(divs.has("Processing")) PROC_WORK.forEach(w=>{ if(!work.includes(w)) work.push(w); });
  return work;
}

function refreshFeeTypeOptionsFromData(){
  const types = new Set();
  ALL_FEES.forEach(r=>{
    const t = r.Fee_Type || r.FeeType || r.Type || r["Fee Type"];
    if(t) types.add(String(t));
  });
  const arr = Array.from(types);
  if(arr.length) return arr.sort((a,b)=>a.localeCompare(b));
  return FEE_TYPES;
}

/* ===========================
   RESET
=========================== */
function resetFilters(){
  msState.division = new Set(["CSR","Processing"]);
  msState.staff.clear();
  msState.work.clear();
  msState.fee.clear();
  initMultiSelects(true);
  runReport();
}

/* ===========================
   BACKEND FETCH
=========================== */
async function fetchReportData(params){
  const qs = new URLSearchParams(params);
  const url = WEB_APP_URL + "?" + qs.toString();
  const res = await fetch(url, { method:"GET" });
  return await res.json();
}

/* ===========================
   APPLY FILTERS (CLIENT FALLBACK)
=========================== */
function applyAllFilters(startISO, endISO){
  const divs = selectedDivisions();
  const staffSet = getFilterSet("staff", refreshStaffOptionsFromData());
  const workSet = getFilterSet("work", refreshWorkOptions());
  const feeSet = getFilterSet("fee", refreshFeeTypeOptionsFromData());

  // CSR rows filtered by date + staff
  let csr = ALL_CSR
    .map(r=>{
      const d = normISO(r.Date);
      return { ...r, _DateISO:d };
    })
    .filter(r=>divs.has("CSR") && staffSet.has(String(r.Staff||"")) && betweenISO(r._DateISO, startISO, endISO));

  // Processing rows filtered by date + staff
  let proc = ALL_PROC
    .map(r=>{
      const d = normISO(r.Date);
      return { ...r, _DateISO:d };
    })
    .filter(r=>divs.has("Processing") && staffSet.has(String(r.Staff||"")) && betweenISO(r._DateISO, startISO, endISO));

  // Fee rows filtered by date + staff + fee type
  let fees = ALL_FEES
    .map(r=>{
      const d = normISO(r.Date);
      const staff = String(r.Staff||"");
      const type = String(r.Fee_Type || r.FeeType || r.Type || r["Fee Type"] || "");
      const count = Number(r.Count || r.Entries || r.EntryCount || 0) || 0;
      const total = Number(r.Total_Fee || r.TotalFee || r.Total || 0) || 0;
      return { ...r, _DateISO:d, _Staff:staff, _Type:type, _Count:count, _Total:total };
    })
    .filter(r=>betweenISO(r._DateISO, startISO, endISO) && staffSet.has(r._Staff) && feeSet.has(r._Type));

  return { csr, proc, fees, workSet, feeSet, divs };
}

/* ===========================
   SUMMARISERS (RESPECT WORK FILTER)
=========================== */
function sumCSRRow(r, workSet){
  const inbound = Number(r.Inbound||0);
  const outbound = Number(r.Outbound||0);
  const chat = Number(r.Chat||0);
  const emails = Number(r.Emails||0);
  const a2a = Number(r.A2A||0);
  const unverified = Number(r.Unverified||0);
  const incc = Number(r.INC_C_Calling||0) || Number(r["INC/C Calling"]||0) || Number(r.INC_C||0);
  const qc = Number(r.Question_Calling||0) || Number(r["Question Calling"]||0);
  const a2ac = Number(r.A2A_Calling||0) || Number(r["A2A Calling"]||0);
  const delinks = Number(r.Delinks||0);
  const cancels = Number(r.Cancellations||0) || Number(r.Cancels||0);

  const map = {
    "Inbound": inbound,
    "Outbound": outbound,
    "Chat": chat,
    "Emails": emails,
    "A2A": a2a,
    "Unverified": unverified,
    "INC/C Calling": incc,
    "Question Calling": qc,
    "A2A Calling": a2ac,
    "Delinks": delinks,
    "Cancellations": cancels
  };
  const out = {};
  Object.keys(map).forEach(k=>{
    out[k] = workSet.has(k) ? (Number(map[k])||0) : 0;
  });
  return out;
}

function sumProcRow(r, workSet){
  const filing = Number(r.Filing||0);
  const linking = Number(r.Linking||0);
  const linkedreview = Number(r["Linked Review"]||0) || Number(r.LinkedReview||0) || Number(r.Linked_Review||0);
  const inbox = Number(r.Inbox||0);
  const existingreview = Number(r["Existing Review"]||0) || Number(r.ExistingReview||0);
  const processingreview = Number(r["Processing Review"]||0) || Number(r.ProcessingReview||0);
  const misc = Number(r.Miscellaneous||0) || Number(r.Misc||0);

  const map = {
    "Filing": filing,
    "Linking": linking,
    "Linked Review": linkedreview,
    "Inbox": inbox,
    "Existing Review": existingreview,
    "Processing Review": processingreview,
    "Miscellaneous": misc
  };
  const out = {};
  Object.keys(map).forEach(k=>{
    out[k] = workSet.has(k) ? (Number(map[k])||0) : 0;
  });
  const totalOutput = Object.values(out).reduce((a,b)=>a+(Number(b)||0),0);
  return { out, totalOutput };
}

/* ===========================
   MAIN REPORT
=========================== */
async function runReport(){
  setStatus("Loading…");

  const startISO = document.getElementById("startDate").value || todayISO;
  const endISO = document.getElementById("endDate").value || todayISO;
  const isToday = (startISO===todayISO && endISO===todayISO);
  document.getElementById("rangeLabel").textContent = isToday ? "Today (live)" : `${startISO} → ${endISO}`;

  // Build params for backend filtering (as requested)
  const divArr = Array.from(msState.division.size ? msState.division : new Set(["CSR","Processing"]));
  const staffArr = Array.from(msState.staff);
  const workArr = Array.from(msState.work);
  const feeArr = Array.from(msState.fee);

  const params = {
    action: "getReportData",
    start: startISO,
    end: endISO,
    division: divArr.join(","),
    staff: staffArr.join(","),
    work: workArr.join(","),
    fee: feeArr.join(",")
  };

  try{
    const data = await fetchReportData(params);
    if(!data.ok){
      alert(data.error || "Unknown backend error");
      setStatus("Error");
      return;
    }

    // Store raw
    ALL_CSR = Array.isArray(data.csr) ? data.csr : [];
    ALL_PROC = Array.isArray(data.processing) ? data.processing : [];
    ALL_FEES = Array.isArray(data.fees) ? data.fees : [];

    // Rebuild filter UIs based on real data (but keep current selections)
    initMultiSelects(false);

    // Apply (client fallback)
    const filtered = applyAllFilters(startISO, endISO);

    // Yesterday (for deltas): we compare start date as primary day vs previous day (same UI approach you already had)
    const day = startISO;
    const ydayISO = addDaysISO(day, -1);

    // For yday comparisons, we re-filter against yday only (single day), with same filters
    const yFiltered = applyAllFilters(ydayISO, ydayISO);

    /* ===== CSR totals ===== */
    let csrInbound=0, csrOutbound=0, csrChat=0, csrEmails=0, csrTouch=0;
    filtered.csr.forEach(r=>{
      const s = sumCSRRow(r, filtered.workSet);
      csrInbound += s["Inbound"];
      csrOutbound += s["Outbound"];
      csrChat += s["Chat"];
      csrEmails += s["Emails"];
      csrTouch += (s["Inbound"] + s["Outbound"] + s["Chat"]);
    });

    let csrTouchY=0;
    yFiltered.csr.forEach(r=>{
      const s = sumCSRRow(r, yFiltered.workSet);
      csrTouchY += (s["Inbound"] + s["Outbound"] + s["Chat"]);
    });

    /* ===== Processing totals ===== */
    let procOutput=0;
    filtered.proc.forEach(r=>{
      const sp = sumProcRow(r, filtered.workSet);
      procOutput += sp.totalOutput;
    });

    let procOutputY=0;
    yFiltered.proc.forEach(r=>{
      const sp = sumProcRow(r, yFiltered.workSet);
      procOutputY += sp.totalOutput;
    });

    /* ===== Fees + entries from Fee_Log ONLY ===== */
    let feeTotal=0, feeEntries=0;
    filtered.fees.forEach(f=>{
      feeTotal += Number(f._Total||0);
      feeEntries += Number(f._Count||0);
    });
    feeTotal = Math.round(feeTotal*100)/100;

    let feeTotalY=0, feeEntriesY=0;
    yFiltered.fees.forEach(f=>{
      feeTotalY += Number(f._Total||0);
      feeEntriesY += Number(f._Count||0);
    });
    feeTotalY = Math.round(feeTotalY*100)/100;

    /* ===== Active staff ===== */
    function activeCount(ff){
      const staffActive = new Set();

      // CSR: any activity in any selected CSR fields
      ff.csr.forEach(r=>{
        const s = sumCSRRow(r, ff.workSet);
        const total = Object.values(s).reduce((a,b)=>a+(Number(b)||0),0);
        if(total>0) staffActive.add(String(r.Staff||""));
      });

      // Processing: any output activity OR fee entries
      ff.proc.forEach(r=>{
        const sp = sumProcRow(r, ff.workSet);
        if(sp.totalOutput>0) staffActive.add(String(r.Staff||""));
      });

      // Fee log: any entries
      ff.fees.forEach(f=>{
        if((Number(f._Count)||0)>0) staffActive.add(String(f._Staff||""));
      });

      // remove blanks
      staffActive.delete("");
      return staffActive.size;
    }

    const activeToday = activeCount(filtered);
    const activeYday = activeCount(yFiltered);

    /* ===== Update Summary Cards ===== */
    document.getElementById("touchpointsToday").textContent = csrTouch.toLocaleString("en-NZ");
    document.getElementById("touchpointsYday").textContent = csrTouchY.toLocaleString("en-NZ");
    formatDelta(document.getElementById("touchpointsDelta"), csrTouch, csrTouchY);

    document.getElementById("returnsToday").textContent = procOutput.toLocaleString("en-NZ");
    document.getElementById("returnsYday").textContent = procOutputY.toLocaleString("en-NZ");
    formatDelta(document.getElementById("returnsDelta"), procOutput, procOutputY);

    document.getElementById("feesToday").textContent = money(feeTotal);
    document.getElementById("feesYday").textContent = money(feeTotalY);
    formatDelta(document.getElementById("feesDelta"), feeTotal, feeTotalY);

    document.getElementById("activeStaffToday").textContent = activeToday.toLocaleString("en-NZ");
    document.getElementById("activeStaffYday").textContent = activeYday.toLocaleString("en-NZ");
    formatDelta(document.getElementById("activeDelta"), activeToday, activeYday);

    /* ===== Division Snapshot ===== */
    document.getElementById("csrTouchpoints").textContent = csrTouch.toLocaleString("en-NZ");
    document.getElementById("csrInbound").textContent = csrInbound.toLocaleString("en-NZ");
    document.getElementById("csrOutbound").textContent = csrOutbound.toLocaleString("en-NZ");
    document.getElementById("csrChat").textContent = csrChat.toLocaleString("en-NZ");

    document.getElementById("procOutput").textContent = procOutput.toLocaleString("en-NZ");
    document.getElementById("procFees").textContent = money(feeTotal);
    document.getElementById("procFeeEntries").textContent = feeEntries.toLocaleString("en-NZ");

    /* ===== CSR Ranking + Full ===== */
    const csrRank = filtered.csr.map(r=>{
      const s = sumCSRRow(r, filtered.workSet);
      const tp = s["Inbound"] + s["Outbound"] + s["Chat"];
      return {
        name: String(r.Staff||""),
        touchpoints: tp,
        inbound: s["Inbound"],
        outbound: s["Outbound"],
        chat: s["Chat"],
        emails: s["Emails"],
        a2a: s["A2A"],
        unverified: s["Unverified"],
        incc: s["INC/C Calling"],
        qc: s["Question Calling"],
        a2ac: s["A2A Calling"],
        delink: s["Delinks"],
        cancel: s["Cancellations"]
      };
    }).sort((a,b)=>b.touchpoints-a.touchpoints);

    document.getElementById("csrRankBody").innerHTML =
      csrRank.length ? csrRank.map((r,i)=>`
        <tr>
          <td>${i+1}</td>
          <td><strong>${escapeHtml(r.name)}</strong></td>
          <td class="right"><strong>${r.touchpoints.toLocaleString("en-NZ")}</strong></td>
          <td class="right">${r.inbound.toLocaleString("en-NZ")}</td>
          <td class="right">${r.outbound.toLocaleString("en-NZ")}</td>
          <td class="right">${r.chat.toLocaleString("en-NZ")}</td>
          <td class="right">${r.emails.toLocaleString("en-NZ")}</td>
        </tr>
      `).join("")
      : `<tr><td colspan="7" class="small-muted">No CSR data for current filters.</td></tr>`;

    document.getElementById("csrFullBody").innerHTML =
      csrRank.length ? csrRank.map(r=>`
        <tr>
          <td><strong>${escapeHtml(r.name)}</strong></td>
          <td class="right">${r.inbound}</td>
          <td class="right">${r.outbound}</td>
          <td class="right">${r.chat}</td>
          <td class="right">${r.emails}</td>
          <td class="right">${r.a2a}</td>
          <td class="right">${r.unverified}</td>
          <td class="right">${r.incc}</td>
          <td class="right">${r.qc}</td>
          <td class="right">${r.a2ac}</td>
          <td class="right">${r.delink}</td>
          <td class="right">${r.cancel}</td>
        </tr>
      `).join("")
      : `<tr><td colspan="12" class="small-muted">No CSR data for current filters.</td></tr>`;

    /* ===== Processing Ranking + Full ===== */
    // Build fee totals per staff from Fee_Log (already filtered)
    const feeByStaff = {};
    filtered.fees.forEach(f=>{
      const staff = f._Staff;
      if(!feeByStaff[staff]) feeByStaff[staff] = { total:0, entries:0 };
      feeByStaff[staff].total += Number(f._Total||0);
      feeByStaff[staff].entries += Number(f._Count||0);
    });

    const procRank = filtered.proc.map(r=>{
      const sp = sumProcRow(r, filtered.workSet);
      const staff = String(r.Staff||"");
      const feesForStaff = feeByStaff[staff] || { total:0, entries:0 };
      return {
        name: staff,
        filing: sp.out["Filing"]||0,
        linking: sp.out["Linking"]||0,
        linkedreview: sp.out["Linked Review"]||0,
        inbox: sp.out["Inbox"]||0,
        existingreview: sp.out["Existing Review"]||0,
        processingreview: sp.out["Processing Review"]||0,
        misc: sp.out["Miscellaneous"]||0,
        totalOutput: sp.totalOutput||0,
        fees: Math.round((feesForStaff.total||0)*100)/100,
        entries: feesForStaff.entries||0
      };
    }).sort((a,b)=>{
      if(b.fees!==a.fees) return b.fees-a.fees;
      return b.totalOutput-a.totalOutput;
    });

    document.getElementById("procRankBody").innerHTML =
      procRank.length ? procRank.map((r,i)=>`
        <tr>
          <td>${i+1}</td>
          <td><strong>${escapeHtml(r.name)}</strong></td>
          <td class="right"><strong>${money(r.fees)}</strong></td>
          <td class="right">${Number(r.entries||0).toLocaleString("en-NZ")}</td>
          <td class="right">${Number(r.totalOutput||0).toLocaleString("en-NZ")}</td>
        </tr>
      `).join("")
      : `<tr><td colspan="5" class="small-muted">No Processing data for current filters.</td></tr>`;

    document.getElementById("procFullBody").innerHTML =
      procRank.length ? procRank.map(r=>`
        <tr>
          <td><strong>${escapeHtml(r.name)}</strong></td>
          <td class="right">${r.filing}</td>
          <td class="right">${r.linking}</td>
          <td class="right">${r.linkedreview}</td>
          <td class="right">${r.inbox}</td>
          <td class="right">${r.existingreview}</td>
          <td class="right">${r.processingreview}</td>
          <td class="right">${r.misc}</td>
          <td class="right"><strong>${Number(r.totalOutput||0)}</strong></td>
          <td class="right"><strong>${money(r.fees)}</strong></td>
          <td class="right">${Number(r.entries||0)}</td>
        </tr>
      `).join("")
      : `<tr><td colspan="11" class="small-muted">No Processing data for current filters.</td></tr>`;

    /* ===== Fee Breakdown By Type (Fee_Log ONLY) ===== */
    const feeTotals = {};
    const feeTypeOptions = refreshFeeTypeOptionsFromData();
    feeTypeOptions.forEach(t=>feeTotals[t]={entries:0,total:0});

    filtered.fees.forEach(f=>{
      const t = f._Type || "";
      if(!feeTotals[t]) feeTotals[t] = { entries:0, total:0 };
      feeTotals[t].entries += Number(f._Count||0);
      feeTotals[t].total += Number(f._Total||0);
    });

    let totalEntries = 0, totalFees = 0;
    const feeRowsHtml = feeTypeOptions.map(t=>{
      const v = feeTotals[t] || { entries:0, total:0 };
      totalEntries += v.entries;
      totalFees += v.total;
      return `
        <tr>
          <td><strong>${escapeHtml(t)}</strong></td>
          <td class="right">${Number(v.entries||0).toLocaleString("en-NZ")}</td>
          <td class="right">${money(Math.round((v.total||0)*100)/100)}</td>
        </tr>
      `;
    }).join("");

    document.getElementById("feeTypeBody").innerHTML = feeRowsHtml || `<tr><td colspan="3" class="small-muted">No fee data for current filters.</td></tr>`;
    document.getElementById("feeTypeTotalEntries").textContent = totalEntries.toLocaleString("en-NZ");
    document.getElementById("feeTypeTotalFees").textContent = money(Math.round(totalFees*100)/100);

    setStatus(isToday ? "Live Today" : "Filtered period");

  }catch(err){
    console.error(err);
    alert("Connection error");
    setStatus("Connection error");
  }
}

/* ===========================
   PDF (placeholder until wiring)
=========================== */
function downloadPDF(){
  alert("PDF will match the current filters when backend wiring is added.");
}

/* ===========================
   INIT MULTISELECTS (DATA-DRIVEN)
=========================== */
function initMultiSelects(forceRebuildAll){
  const msDiv = document.querySelector('[data-ms="division"]');
  const msStaff = document.querySelector('[data-ms="staff"]');
  const msWork = document.querySelector('[data-ms="work"]');
  const msFee = document.querySelector('[data-ms="fee"]');

  // Build DIVISION (static)
  msDiv.innerHTML = "";
  buildMultiSelect(msDiv, "division", ["CSR","Processing"]);

  // Build STAFF from data
  const staffOpts = refreshStaffOptionsFromData();
  // prune invalid staff selections
  Array.from(msState.staff).forEach(v=>{ if(!staffOpts.includes(v)) msState.staff.delete(v); });

  msStaff.innerHTML = "";
  buildMultiSelect(msStaff, "staff", staffOpts.length ? staffOpts : []);

  // Build WORK based on division selection
  const workOpts = refreshWorkOptions();
  Array.from(msState.work).forEach(v=>{ if(!workOpts.includes(v)) msState.work.delete(v); });

  msWork.innerHTML = "";
  buildMultiSelect(msWork, "work", workOpts);

  // Build FEE TYPES from Fee_Log (fallback to default list)
  const feeOpts = refreshFeeTypeOptionsFromData();
  Array.from(msState.fee).forEach(v=>{ if(!feeOpts.includes(v)) msState.fee.delete(v); });

  msFee.innerHTML = "";
  buildMultiSelect(msFee, "fee", feeOpts);

  // If division applies, rebuild staff/work quickly
  msDiv.addEventListener("click",(e)=>{
    const btn = e.target.closest('[data-act="apply"]');
    if(btn){
      setTimeout(()=>initMultiSelects(false),0);
    }
  });
}

/* Safe HTML */
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ===========================
   BOOT
=========================== */
(function boot(){
  // Initial multiselects (empty data, still renders)
  initMultiSelects(true);
  // Run report on load
  runReport();
})();
</script>

</body>
</html>
