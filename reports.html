<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>My Refund — Reports</title>

<style>
:root{
  --g0:#094B35;
  --g1:#03953F;
  --g2:#ECFDF5;
  --bg:#f6f7f8;
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
  --shadow:0 10px 25px rgba(0,0,0,.06);
  --radius:16px;
}

body{
  margin:0;
  background:linear-gradient(180deg,var(--g2) 0%, #ffffff 55%, var(--bg) 100%);
  color:var(--text);
  font-family:"Okta Neue", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
}

.wrap{max-width:1100px;margin:0 auto;padding:18px 18px 42px;}

.topbar{
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  padding:10px 12px;border-radius:18px;background:#fff;border:1px solid var(--border);
  box-shadow:0 6px 18px rgba(0,0,0,.04);
  position:sticky;top:10px;z-index:10;
}

.brand{display:flex;align-items:center;gap:12px;}
.brand img{height:28px;}
.brand .title strong{color:var(--g0);font-size:14px;}
.brand .title span{color:var(--muted);font-size:12px;}

.controls{
  display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;
}

.field{display:flex;flex-direction:column;gap:6px;}
label{font-size:12px;color:var(--muted);font-weight:800;}

input[type="date"], select{
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
  font-size:14px;
  background:#fff;
  min-width:150px;
}

input:focus, select:focus{
  border-color:rgba(3,149,63,.45);
  box-shadow:0 0 0 3px rgba(3,149,63,.12);
  outline:none;
}

.btn{
  border:1px solid var(--g0);
  background:var(--g0);
  color:#fff;
  border-radius:12px;
  padding:10px 14px;
  font-weight:900;
  cursor:pointer;
  font-size:14px;
}

.btn.secondary{
  background:#fff;color:var(--g0);
}

.pill{
  padding:8px 10px;border-radius:999px;
  background:var(--g2);
  border:1px solid rgba(3,149,63,.18);
  color:var(--g0);
  font-weight:900;font-size:12px;
}

.content{
  margin-top:16px;
  display:grid;
  grid-template-columns:1.1fr .9fr;
  gap:16px;
}

.card{
  background:#fff;
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  overflow:hidden;
}

.card .hd{
  padding:14px 16px;
  border-bottom:1px solid var(--border);
  display:flex;justify-content:space-between;
}

.card .hd h2{
  margin:0;font-size:16px;color:var(--g0);
}

.card .bd{padding:14px 16px;}

.empty{
  background:var(--g2);
  border:1px dashed rgba(3,149,63,.35);
  border-radius:14px;
  padding:12px;
  color:var(--g0);
  font-weight:900;
}

table{width:100%;border-collapse:collapse;}
th,td{border-bottom:1px solid var(--border);padding:10px 8px;font-size:13px;}
th{color:var(--muted);font-weight:900;text-align:left;}
.right{text-align:right;}

@media(max-width:980px){
  .content{grid-template-columns:1fr;}
}
</style>
</head>

<body>
<div class="wrap">

<div class="topbar">
  <div class="brand">
    <img src="assets/logo.png" alt="My Refund logo" onerror="this.style.display='none';">
    <div class="title">
      <strong>Reports</strong>
      <span>Team totals + productivity</span>
    </div>
  </div>

  <div class="controls">

    <div class="field">
      <label>Start date</label>
      <input type="date" id="startDate">
    </div>

    <div class="field">
      <label>End date</label>
      <input type="date" id="endDate">
    </div>

    <div class="field">
      <label>Division</label>
      <select id="divisionFilter">
        <option value="All">All</option>
        <option value="CSR">CSR</option>
        <option value="Processing">Processing</option>
      </select>
    </div>

    <div class="field">
      <label>Work type</label>
      <select id="workFilter"></select>
    </div>

    <button class="btn secondary" id="runBtn">Run report</button>
    <button class="btn" id="pdfBtn">Download PDF</button>

    <div class="pill" id="statusPill">Ready</div>
  </div>
</div>

<div class="content">

  <div class="card">
    <div class="hd">
      <h2>Team totals</h2>
      <small id="teamRangeLabel">No period selected</small>
    </div>
    <div class="bd" id="teamTotalsArea">
      <div class="empty">No data yet</div>
    </div>
  </div>

  <div class="card">
    <div class="hd">
      <h2>Individual productivity</h2>
      <small id="prodRangeLabel">No period selected</small>
    </div>
    <div class="bd" id="productivityArea">
      <div class="empty">No data yet</div>
    </div>
  </div>

</div>
</div>

<script>
const WEB_APP_URL="https://script.google.com/macros/s/AKfycbxrteoDa30Q_uz2-O4j_HE_agEpsCl7LlnPTghyWktDp2VXykkSHjoAqeZ4Jiz3nnYJ/exec";
const DATA_ACTION="report";
const PDF_ACTION="pdf";
const TZ="Pacific/Auckland";

/* Mock dynamic work library */
const CSR_WORK=["A2A","Unverified","Emails","INC/C Calling","Question Calling","A2A Calling"];
const PROCESSING_WORK=["Filing","Linking","Linked Review","Inbox","Existing Review","Processing Review","Miscellaneous"];

const startEl=document.getElementById("startDate");
const endEl=document.getElementById("endDate");
const divisionFilter=document.getElementById("divisionFilter");
const workFilter=document.getElementById("workFilter");
const runBtn=document.getElementById("runBtn");
const pdfBtn=document.getElementById("pdfBtn");
const statusPill=document.getElementById("statusPill");
const teamTotalsArea=document.getElementById("teamTotalsArea");
const productivityArea=document.getElementById("productivityArea");
const teamRangeLabel=document.getElementById("teamRangeLabel");
const prodRangeLabel=document.getElementById("prodRangeLabel");

function nzTodayISO(){
  return new Date().toLocaleDateString("en-CA",{timeZone:TZ});
}

function setStatus(text){statusPill.textContent=text;}

function populateWorkFilter(){
  const division=divisionFilter.value;
  workFilter.innerHTML=`<option value="All">All Work</option>`;
  let list=[];
  if(division==="CSR") list=CSR_WORK;
  else if(division==="Processing") list=PROCESSING_WORK;
  else list=[...CSR_WORK,...PROCESSING_WORK];
  list.forEach(w=>{
    const opt=document.createElement("option");
    opt.value=w;
    opt.textContent=w;
    workFilter.appendChild(opt);
  });
}

function buildEmptyMessage(){
  const division=divisionFilter.value;
  const work=workFilter.value;
  const start=startEl.value;
  const end=endEl.value;
  let divText=division==="All"?"work":division+" work";
  let workText=work==="All"?"":` of type '${work}'`;
  return `No ${divText}${workText} found for ${start} to ${end}.`;
}

function buildTable(area,rows,headers){
  if(!rows||!rows.length){
    area.innerHTML=`<div class="empty">${buildEmptyMessage()}</div>`;
    return;
  }
  const thead=headers.map(h=>`<th>${h}</th>`).join("");
  const tbody=rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join("")}</tr>`).join("");
  area.innerHTML=`<table><thead><tr>${thead}</tr></thead><tbody>${tbody}</tbody></table>`;
}

async function fetchReport(start,end){
  const division=divisionFilter.value;
  const work=workFilter.value;
  const url=`${WEB_APP_URL}?action=${DATA_ACTION}&start=${start}&end=${end}&division=${division}&work=${work}`;
  const res=await fetch(url);
  return await res.json();
}

async function runReport(){
  const start=startEl.value;
  const end=endEl.value;
  if(!start||!end){alert("Select both dates");return;}
  teamRangeLabel.textContent=`${start} to ${end}`;
  prodRangeLabel.textContent=`${start} to ${end}`;
  setStatus("Loading…");
  try{
    const data=await fetchReport(start,end);
    buildTable(teamTotalsArea,data.teamTotals||[],["Work","Starting","Completed","Remaining"]);
    buildTable(productivityArea,data.staffStats||[],["Staff","Hours","Interactions","Avg time","Rate"]);
    setStatus("Up to date");
  }catch(e){
    teamTotalsArea.innerHTML=`<div class="empty">${buildEmptyMessage()}</div>`;
    productivityArea.innerHTML=`<div class="empty">${buildEmptyMessage()}</div>`;
    setStatus("Error");
  }
}

function downloadPdf(){
  const start=startEl.value;
  const end=endEl.value;
  const division=divisionFilter.value;
  const work=workFilter.value;
  const url=`${WEB_APP_URL}?action=${PDF_ACTION}&start=${start}&end=${end}&division=${division}&work=${work}`;
  window.open(url,"_blank");
}

(function init(){
  const today=nzTodayISO();
  startEl.value=today;
  endEl.value=today;
  populateWorkFilter();
  divisionFilter.addEventListener("change",populateWorkFilter);
  runBtn.addEventListener("click",runReport);
  pdfBtn.addEventListener("click",downloadPdf);
  runReport();
})();
</script>
</body>
</html>
